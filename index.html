<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#fff0f5">
    <title>å¸ƒå…‹æ—…éŠæ‰‹å¸³</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --bg-body: #f3f4f6;
            --bg-app: #fff;
            --primary: #ffb7c5;
            --primary-dark: #ff8fa3;
            --secondary: #f8f9fa; 
            --accent: #9dc4b5;
            --text-main: #2c2c2c; 
            --text-sub: #5f6368; 
            --border-radius: 20px;
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --danger: #e53935;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        [data-theme="matcha"] { --bg-body: #eef5ee; --primary: #88a886; --primary-dark: #6b8c69; --secondary: #f1f8f1; --accent: #d4a373; }
        [data-theme="ocean"] { --bg-body: #e3f2fd; --primary: #64b5f6; --primary-dark: #1976d2; --secondary: #eef7ff; --accent: #ffb7b2; }
        [data-theme="dark"] { --bg-body: #121212; --bg-app: #1e1e1e; --primary: #bb86fc; --primary-dark: #9955e8; --secondary: #2d2d2d; --accent: #03dac6; --text-main: #e0e0e0; --text-sub: #aaa; --card-shadow: 0 8px 24px rgba(0,0,0,0.4); }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg-body); font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; margin: 0; color: var(--text-main); display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        .app-container { width: 100%; max-width: 500px; background-color: var(--bg-app); min-height: 100vh; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.05); display: flex; flex-direction: column; }

        /* HEADER */
        header { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); padding: calc(15px + var(--safe-area-top)) 20px 10px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(0,0,0,0.08); transition: all 0.3s ease; }
        [data-theme="dark"] header { background: rgba(30, 30, 30, 0.95); border-bottom-color: #333; }
        .header-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .app-title-group { display: flex; flex-direction: column; flex: 1; overflow: hidden; margin-left: 10px; }
        h1 { margin: 0; font-size: 22px; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .subtitle { font-size: 12px; color: var(--text-sub); margin-top: 2px; cursor: pointer; }
        .btn-icon-only { background: var(--secondary); border: 1px solid rgba(0,0,0,0.05); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; cursor: pointer; transition: transform 0.1s; color: var(--text-main); }
        .btn-icon-only:active { transform: scale(0.9); }

        /* NAV TABS */
        .nav-tabs-container { width: 100%; padding: 5px 0; overflow-x: visible; white-space: normal; }
        .nav-tabs { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-start; }
        .tab { padding: 8px 10px; border-radius: 12px; font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s; background: rgba(0,0,0,0.03); color: var(--text-sub); border: 1px solid transparent; flex: 1 1 auto; text-align: center; min-width: 60px; }
        .tab.active { background: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.15); transform: translateY(-1px); }
        [data-theme="dark"] .tab.active { color: #000; }
        [data-theme="dark"] .tab { background: rgba(255,255,255,0.05); }

        /* DAY SELECTOR */
        .day-selector-wrapper { display: flex; overflow-x: auto; gap: 12px; padding: 10px 5px 20px 5px; margin: 0 -5px; scrollbar-width: none; }
        .day-selector-wrapper::-webkit-scrollbar { display: none; }
        .day-tab-item { flex: 0 0 70px; height: 75px; background: var(--bg-app); border-radius: 18px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.2s; border: 2px solid #f0f0f0; position: relative; overflow: hidden; }
        .day-tab-item.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: translateY(-3px); }
        .day-tab-num { font-size: 20px; font-weight: bold; line-height: 1; }
        .day-tab-label { font-size: 11px; margin-top: 4px; opacity: 0.9; }
        [data-theme="dark"] .day-tab-item { background: #333; color: #fff; border-color: #444; }
        [data-theme="dark"] .day-tab-item.active { background: var(--primary); color: #000; }

        /* CARDS & LISTS */
        .content-view { flex: 1; padding: 20px; display: none; animation: fadeIn 0.4s ease; padding-bottom: calc(40px + var(--safe-area-bottom)); }
        .content-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--bg-app); border-radius: var(--border-radius); padding: 20px; margin-bottom: 24px; box-shadow: var(--card-shadow); position: relative; border: 1px solid rgba(0,0,0,0.05); }
        [data-theme="dark"] .card { border: 1px solid rgba(255,255,255,0.05); }
        .card h3, .card h4 { margin: 0 0 15px 0; font-size: 18px; display: flex; align-items: center; justify-content: space-between; }
        
        .list-item-card { background: #fff; border: 1px solid #eee; border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; align-items: flex-start; gap: 12px; transition: transform 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .list-item-card:active { transform: scale(0.99); background: #fafafa; }
        [data-theme="dark"] .list-item-card { background: #2d2d2d; border-color: #444; }

        /* --- BOARDING PASS STYLE --- */
        .bp-card { background: #fff; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); margin-bottom: 15px; overflow: hidden; border: 1px solid rgba(0,0,0,0.08); display: flex; flex-direction: column; cursor: pointer; transition: transform 0.2s; position: relative; }
        .bp-card:active { transform: scale(0.99); }
        .bp-header { background: var(--primary); color: #fff; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: bold; }
        .bp-body { padding: 15px; display: flex; flex-direction: column; gap: 10px; position: relative; }
        .bp-route-row { display: flex; justify-content: space-between; align-items: center; }
        .bp-code { font-size: 32px; font-weight: 800; line-height: 1; color: var(--text-main); }
        .bp-icon { color: var(--primary-dark); font-size: 20px; display: flex; flex-direction: column; align-items: center; }
        .bp-icon span { font-size: 10px; letter-spacing: 1px; margin-top: -5px; color: var(--text-sub); }
        .bp-details-row { display: flex; justify-content: space-between; background: var(--secondary); padding: 8px 12px; border-radius: 10px; margin-top: 5px; }
        .bp-label { font-size: 10px; color: var(--text-sub); text-transform: uppercase; }
        .bp-val { font-size: 14px; font-weight: bold; color: var(--text-main); }
        .bp-footer { border-top: 2px dashed #eee; padding: 10px; text-align: center; position: relative; }
        .bp-footer::before, .bp-footer::after { content: ''; position: absolute; top: -10px; width: 20px; height: 20px; background: var(--bg-app); border-radius: 50%; }
        .bp-footer::before { left: -10px; } .bp-footer::after { right: -10px; }
        .bp-barcode { font-family: 'Libre Barcode 39 Text', cursive; font-size: 36px; color: #333; line-height: 1; opacity: 0.7; }
        
        /* ä¿®æ”¹å¾Œçš„åˆªé™¤æŒ‰éˆ•æ¨£å¼ */
        .bp-delete-btn {
            position: absolute;
            /* æ”¹ç‚ºå®šä½åœ¨ Footer å€åŸŸçš„å³å´ä¸­é–“åä¸‹ */
            top: 50%; 
            right: 15px;
            transform: translateY(-50%); /* è®“æŒ‰éˆ•å‚ç›´ç½®ä¸­ */
            
            background: #fff; /* æ”¹ç‚ºç™½è‰²èƒŒæ™¯æ¯”è¼ƒä¹¾æ·¨ */
            color: var(--text-sub); /* æ”¹ç‚ºæ·±ç°è‰²ï¼Œæ¯”è¼ƒåƒæ¬¡è¦åŠŸèƒ½ */
            border: 1px solid #eee; /* åŠ ä¸Šç´°é‚Šæ¡† */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s;
            font-size: 14px; /* åœ–ç¤ºç¨å¾®ç¸®å° */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); /* å¢åŠ ä¸€é»é™°å½± */
        }
        
        .bp-delete-btn:active { 
            transform: translateY(-50%) scale(0.9); 
            background: #ffeeee; 
            color: var(--danger);
            border-color: var(--danger);
        }
        
        /* --- HOTEL DOORPLATE STYLE --- */
        .hotel-doorplate { background: #fff; border: 2px solid var(--primary); border-radius: 8px; padding: 15px 20px; margin-bottom: 15px; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 15px; transition: transform 0.2s; }
        [data-theme="dark"] .hotel-doorplate { background: #2d2d2d; border-color: #444; }
        .hotel-doorplate:active { transform: scale(0.99); }
        .hotel-screw { position: absolute; width: 10px; height: 10px; background: #d1d5db; border-radius: 50%; box-shadow: inset 1px 1px 2px rgba(0,0,0,0.3); }
        .screw-tl { top: 8px; left: 8px; } .screw-tr { top: 8px; right: 8px; } .screw-bl { bottom: 8px; left: 8px; } .screw-br { bottom: 8px; right: 8px; }
        .hotel-icon-badge { width: 50px; height: 50px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--primary); border: 2px solid var(--primary); flex-shrink: 0; }
        .hotel-info-plate { flex: 1; display: flex; flex-direction: column; }
        .hotel-name-plate { font-size: 16px; font-weight: bold; color: var(--text-main); font-family: 'Zen Maru Gothic', sans-serif; margin-bottom: 2px; }
        .hotel-desc-plate { font-size: 13px; color: var(--text-sub); line-height: 1.4; }

        /* --- ITINERARY SPECIFIC STYLES --- */
        .day-weather-mini { 
            background-color: #00f2fe; 
            background: #4facfe; /* Solid color fallback */
            border: 2px solid #ddd;
            border-radius: 16px; 
            padding: 15px 20px; 
            margin-bottom: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            cursor: pointer; 
            color: white; 
            min-height: 70px;
            position: relative;
            z-index: 10;
        }
        .day-weather-mini:active { transform: scale(0.98); opacity: 0.9; }
        .day-weather-mini h3 { margin: 0; font-size: 20px; display: flex; align-items: center; gap: 10px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .day-weather-icon { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        [data-theme="dark"] .day-weather-mini { background: #333; border-color: #555; color: #fff; }

        .it-card-container { display: flex; flex-direction: column; gap: 0px; }

        /* ITINERARY CARDS */
        .it-card { background: #ffffff; border-radius: 20px; padding: 18px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); position: relative; display: flex; flex-direction: column; border-left: 5px solid var(--primary); transition: transform 0.2s; border: 1px solid #f0f0f0; }
        .it-card:active { transform: scale(0.99); }
        [data-theme="dark"] .it-card { border-left-color: #444; background: #333; border: 1px solid #444; }
        .it-card.special-flight { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; border-left: none; box-shadow: 0 10px 20px rgba(0, 242, 254, 0.2); }
        .it-card.special-flight .it-desc { color: rgba(255,255,255,0.9); }
        .it-card.special-flight .it-time, .it-card.special-flight .btn-edit-sm { color: white; background: rgba(255,255,255,0.2); }
        .it-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .it-time { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; padding: 4px 10px; background: var(--secondary); border-radius: 12px; color: var(--primary-dark); }
        .it-body { display: flex; align-items: center; gap: 15px; }
        .it-icon-box { width: 48px; height: 48px; border-radius: 14px; background: var(--secondary); color: #4facfe; font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .it-card.special-flight .it-icon-box { background: rgba(255,255,255,0.2); color: white; }
        .it-info { flex: 1; }
        .it-title { font-size: 16px; font-weight: bold; margin-bottom: 4px; color: var(--text-main); }
        .it-desc { font-size: 13px; color: var(--text-sub); line-height: 1.4; }
        .it-links { margin-top: 8px; display: flex; gap: 8px; }

        /* DAILY TRANSPORT CARD */
        .daily-transport-card { background: #e3f2fd; color: #0d47a1; border-radius: 20px; padding: 18px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(2, 119, 189, 0.1); position: relative; border: 1px solid #bbdefb; }
        .daily-transport-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border-bottom: 1px solid rgba(13, 71, 161, 0.1); padding-bottom: 8px; }
        .daily-transport-item { background: #ffffff; border-radius: 12px; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.03); flex-wrap: wrap; }
        .transport-time { font-weight: bold; background: #bbdefb; color: #0d47a1; padding: 2px 6px; border-radius: 6px; font-size: 13px; white-space: nowrap; }
        .transport-route { font-size: 13px; font-weight:bold; color:#1976d2; display:flex; align-items:center; gap:5px; }
        .transport-duration { font-size: 11px; background:#eee; padding:2px 6px; border-radius:10px; color:#666; margin-left: auto; }
        [data-theme="dark"] .daily-transport-card { background: #1a237e; color: #fff; border-color: #283593; }
        [data-theme="dark"] .daily-transport-item { background: #303f9f; color: #fff; }
        [data-theme="dark"] .transport-time { background: rgba(255,255,255,0.2); color: #fff; }
        [data-theme="dark"] .transport-route { color: #bbdefb; }
        [data-theme="dark"] .transport-duration { background: rgba(0,0,0,0.3); color:#ccc; }

        /* WEATHER CARD */
        .weather-card { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #444; padding: 20px; border-radius: var(--border-radius); margin-bottom: 24px; box-shadow: var(--card-shadow); }
        [data-theme="dark"] .weather-card { background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%); color: #fff; }
        .weather-scroll { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 5px; }
        .weather-day { flex: 0 0 90px; background: rgba(255,255,255,0.6); border-radius: 12px; padding: 10px; text-align: center; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.3); }
        .weather-icon { font-size: 32px; margin: 5px 0; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        
        /* SHOPPING CARD */
        .shop-card { background: #fff; border: 1px solid #eee; border-radius: 16px; margin-bottom: 15px; box-shadow: var(--card-shadow); overflow: hidden; display: flex; transition: opacity 0.3s; }
        .shop-card.bought { opacity: 0.6; background: #f5f5f5; }
        .shop-img-box { width: 100px; height: 100px; background: #eee; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #ccc; }
        .shop-img-box img { width: 100%; height: 100%; object-fit: cover; }
        .shop-info { flex: 1; padding: 12px; display: flex; flex-direction: column; justify-content: center; }
        .shop-title { font-weight: bold; font-size: 15px; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; color: var(--text-main); }
        .shop-price { font-size: 13px; color: var(--primary-dark); font-weight: bold; }
        .shop-desc { font-size: 12px; color: var(--text-sub); margin-top: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* WALLET */
        .wallet-banner { background: linear-gradient(135deg, #434343 0%, #000000 100%); color: #fff; border-radius: var(--border-radius); padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .expense-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer; }
        .expense-icon { width: 45px; height: 45px; background: rgba(0,0,0,0.03); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-right: 12px; flex-shrink: 0; object-fit: cover; }

        /* BUTTONS & ACTIONS */
        button { font-family: inherit; }
        .btn-add-block { width: 100%; padding: 16px; border: 2px dashed #ccc; background: #fff; color: var(--text-sub); border-radius: 16px; cursor: pointer; font-weight: bold; transition: all 0.2s; margin-top: 10px; }
        .btn-add-block:active { background: rgba(0,0,0,0.05); transform: scale(0.98); }
        .btn-pill { padding: 6px 12px; border-radius: 20px; border: none; font-size: 12px; font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; transition: transform 0.1s; }
        .btn-pill:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-secondary { background: #fff; border: 1px solid #ddd; color: var(--text-main); }
        .btn-action { background: #f0f0f0; border: 1px solid #ddd; color: var(--text-main); font-size: 11px; padding: 4px 8px; border-radius: 6px; text-decoration: none; display: inline-block; }
        .btn-delete-icon { background: rgba(0,0,0,0.05); border: none; width: 30px; height: 30px; border-radius: 50%; color: var(--text-sub); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
        .btn-edit { background: rgba(0,0,0,0.05); border: none; width: 30px; height: 30px; border-radius: 50%; color: var(--text-main); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }

        /* MODAL & FORMS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal { background: var(--bg-app); width: 90%; max-width: 400px; padding: 24px; border-radius: 24px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: bold; margin-bottom: 6px; color: var(--text-sub); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 12px; font-family: inherit; font-size: 15px; background: var(--bg-body); color: var(--text-main); transition: border-color 0.2s; }
        .form-input:focus, .form-textarea:focus { border-color: var(--primary); }
        [data-theme="dark"] .form-input, [data-theme="dark"] .form-textarea, [data-theme="dark"] .form-select { border-color: #444; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
        .btn-modal-save { background: var(--primary); color: #fff; border: none; padding: 12px 24px; border-radius: 12px; font-weight: bold; cursor: pointer; flex: 1; }
        .btn-modal-cancel { background: transparent; color: var(--text-sub); border: 1px solid #ddd; padding: 12px 16px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-modal-cancel:hover { background: rgba(0,0,0,0.05); }
        
        /* Event Edit Row Style */
        .event-edit-row { background: var(--secondary); padding: 15px; margin-bottom: 10px; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05); position: relative; }
        .event-edit-row-header { display: flex; gap: 10px; margin-bottom: 10px; }
        
        .clothing-advice { font-size: 11px; color: var(--text-sub); background: rgba(255,255,255,0.7); padding: 2px 6px; border-radius: 8px; display: inline-block; margin-top: 4px; }
        
        /* Checkbox Style for Split */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 5px; font-size: 14px; background: #fff; padding: 5px 10px; border: 1px solid #eee; border-radius: 8px; }
        [data-theme="dark"] .checkbox-item { background: #333; border-color: #444; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-top">
            <button class="btn-icon-only" onclick="openTripManager()" title="æ‰‹å¸³åˆ—è¡¨">ğŸ“š</button>
            <div class="app-title-group" onclick="editHeader()">
                <h1 id="app-title">è¼‰å…¥ä¸­... âœï¸</h1>
                <div id="app-dates" class="subtitle">...</div>
            </div>
            <button class="btn-icon-only" onclick="switchTab('settings')" title="è¨­å®š">âš™ï¸</button>
        </div>
        
        <div class="nav-tabs-container">
            <div class="nav-tabs">
                <div class="tab active" onclick="switchTab('booking')">é¦–é </div>
                <div class="tab" onclick="switchTab('itinerary')">è¡Œç¨‹</div>
                <div class="tab" onclick="switchTab('shopping')">è³¼ç‰©</div>
                <div class="tab" onclick="switchTab('tickets')">ç¥¨åˆ¸</div>
                <div class="tab" onclick="switchTab('wallet')">éŒ¢åŒ…</div>
                <div class="tab" onclick="switchTab('guide')">ç­†è¨˜</div>
            </div>
        </div>
    </header>

    <div id="booking-view" class="content-view active">
        <div class="weather-card" id="home-weather-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="color:inherit; margin:0;">ğŸŒ¤ï¸ ç•¶åœ°å¤©æ°£</h3>
                <div style="font-size:12px; opacity:0.8;"><span id="weather-loc-name">å®šä½ä¸­...</span></div>
            </div>
            <div id="weekly-weather-container" class="weather-scroll">
                <div style="width:100%; text-align:center; padding:15px; opacity:0.6;">è«‹å…ˆåœ¨ã€Œè¡Œç¨‹ã€ä¸­æ–°å¢åœ°é»ä»¥é¡¯ç¤ºå¤©æ°£</div>
            </div>
            <div style="text-align:right; font-size:10px; opacity:0.7; margin-top:8px;">* è³‡æ–™ä¾†æº: Open-Meteo</div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between;"><h3>âœˆï¸ èˆªç­è³‡è¨Š</h3><button onclick="openFlightManager(-1)" class="btn-pill btn-primary">+ æ–°å¢</button></div>
            <div id="booking-flights"></div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3></div>
            <div id="booking-hotels-container"></div>
            <button onclick="openHotelModal()" class="btn-add-block">+ æ–°å¢ä½å®¿</button>
        </div>
    </div>

    <div id="itinerary-view" class="content-view">
        <div id="itinerary-day-selector" class="day-selector-wrapper"></div>
        <div id="itinerary-active-content"></div>
        <button id="btn-add-day" onclick="addDay()" class="btn-add-block">+ æ–°å¢ä¸€å¤©</button>
        <button onclick="copyItineraryText()" class="btn-secondary" style="width:100%; margin-top:10px; border-radius:16px; padding:10px;">ğŸ“‹ è¤‡è£½æ–‡å­—è¡Œç¨‹</button>
    </div>

    <div id="shopping-view" class="content-view">
        <div class="wallet-banner" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%); color:#444; margin-bottom:15px; padding:15px;">
             <div style="display:flex; justify-content:space-between;">
                 <div><div style="font-size:12px; opacity:0.7;">é ä¼°ç¸½é¡</div><div style="font-size:20px; font-weight:bold;" id="shop-total">0</div></div>
                 <div style="text-align:right;"><div style="font-size:12px; opacity:0.7;">å·²è³¼è²·</div><div style="font-size:20px; font-weight:bold; color:var(--primary-dark);" id="shop-bought">0</div></div>
             </div>
        </div>
        <div id="shopping-list-container"></div>
        <button onclick="openShoppingModal()" class="btn-add-block">+ æ–°å¢å¿…è²·æ¸…å–®</button>
    </div>

    <div id="tickets-view" class="content-view">
        <div id="tickets-list" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"></div>
        <button onclick="openTicketModal()" class="btn-add-block" style="grid-column: 1/-1;">+ æ–°å¢ç¥¨åˆ¸/æ†‘è­‰</button>
    </div>

    <div id="wallet-view" class="content-view">
        <div class="wallet-banner">
            <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">ç¸½æ”¯å‡ºé ä¼° (TWD)</div>
            <div id="total-grand-twd" style="font-size:36px; font-weight:bold; font-family:monospace; letter-spacing:-1px;">0</div>
            <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:15px;">
                <div id="my-share-display" style="font-size:13px; color:var(--primary); background:rgba(255,255,255,0.1); padding:4px 8px; border-radius:8px;">å€‹äººæ‡‰ä»˜: 0</div>
                <div style="text-align:right; font-size:12px; opacity:0.7; font-family:monospace; line-height:1.4;" id="currency-totals"></div>
            </div>
        </div>
        <div class="card">
            <h3>ğŸ§® å¿«é€Ÿè¨˜å¸³ & è¨ˆç®—</h3>
            <div style="display:flex; gap:8px; margin-bottom:10px;">
                <input id="calc-input" type="text" placeholder="è¼¸å…¥ç®—å¼ (ä¾‹: 500+200*3)" class="form-input" style="flex:1; text-align:right; font-size:18px;" inputmode="decimal" onkeyup="updateCalc()">
                <select id="calc-currency" onchange="manualRateUpdate()" class="form-select" style="width:90px;"></select>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-size:12px; color:var(--text-sub);">
                    åŒ¯ç‡: <input id="calc-rate" type="number" step="0.0001" style="width:60px; padding:2px; border:none; background:transparent; font-weight:bold; color:var(--accent);" onchange="updateCalc()">
                    <button onclick="openCurrencyManager()" style="border:none; background:none; cursor:pointer;">âš™ï¸ ç®¡ç†å¹£åˆ¥</button>
                </div>
                <div class="calc-display" style="font-size:16px; font-weight:bold; color:var(--text-main);">â‰ˆ NT$ <span id="calc-result-twd">0</span></div>
            </div>
            <button onclick="addExpenseFromCalc()" class="btn-modal-save" style="width:100%;">ğŸ‘‡ è¨˜å¸³</button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h4 style="margin:0;">æ¶ˆè²»ç´€éŒ„</h4>
            <div style="display:flex; gap:10px;">
                <button onclick="openCompanionsModal()" class="btn-pill btn-secondary">ğŸ‘¥ æ—…ä¼´</button>
                <button onclick="clearExpenses()" class="btn-pill btn-secondary" style="color:var(--danger); border-color:var(--danger);">æ¸…é™¤</button>
            </div>
        </div>
        <div id="expense-list"></div>
        <button onclick="openAddExpenseModal()" class="btn-add-block" style="border-style:solid; border-color:var(--primary); color:var(--primary);">+ æ‰‹å‹•æ–°å¢æ¶ˆè²»</button>
    </div>

    <div id="guide-view" class="content-view">
        <div id="guide-tab-bar" class="day-selector-wrapper" style="margin-bottom:20px;"></div>
        <div id="guide-content-area"></div>
        <button id="btn-guide-add" onclick="handleAddInGuide()" class="btn-add-block" style="margin-top:20px;"></button>
    </div>

    <div id="settings-view" class="content-view">
        <div class="card">
            <h3>ğŸ¨ æ‡‰ç”¨ç¨‹å¼é¢¨æ ¼</h3>
            <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:10px;">
                <button class="btn-pill" style="justify-content:center; background:#fff0f5; color:#5e524b; padding:15px;" onclick="setTheme('sakura')">ğŸŒ¸ æ«»èŠ±ç²‰</button>
                <button class="btn-pill" style="justify-content:center; background:#e6f0e6; color:#4b5e4b; padding:15px;" onclick="setTheme('matcha')">ğŸµ æŠ¹èŒ¶ç¶ </button>
                <button class="btn-pill" style="justify-content:center; background:#e0f7fa; color:#3e505b; padding:15px;" onclick="setTheme('ocean')">ğŸŒŠ æ·±æµ·è—</button>
                <button class="btn-pill" style="justify-content:center; background:#333; color:#fff; padding:15px;" onclick="setTheme('dark')">ğŸŒ™ å¤œé–“æ¨¡å¼</button>
            </div>
        </div>
        <div class="card">
            <h3>ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡è½‰ç§»</h3>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button onclick="exportAllCSV()" class="btn-secondary" style="padding:12px; border-radius:12px;">ğŸ“Š åŒ¯å‡ºè³‡æ–™ (Excel CSV)</button>
                <button onclick="openImportCSVModal()" class="btn-secondary" style="padding:12px; border-radius:12px;">ğŸ“¥ åŒ¯å…¥ CSV</button>
                <div style="height:1px; background:#eee; margin:5px 0;"></div>
                <div style="display:flex; gap:10px;">
                    <button onclick="downloadBackup()" class="btn-primary" style="flex:1; padding:12px; border-radius:12px;">å‚™ä»½æª”æ¡ˆ (JSON)</button>
                    <button onclick="document.getElementById('import-file').click()" class="btn-secondary" style="flex:1; padding:12px; border-radius:12px;">é‚„åŸæª”æ¡ˆ</button>
                </div>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="restoreBackup(this)">
            </div>
        </div>
    </div>
</div>

<div id="edit-modal" class="modal-overlay">
    <div class="modal">
        <h3 id="modal-title" style="margin-top:0;">ç·¨è¼¯</h3>
        <div id="modal-content"></div>
        <div class="modal-actions"></div>
    </div>
</div>

<script>
    /* --- 1. CORE UTILS --- */
    let confirmCallback = null;
    const $ = id => document.getElementById(id);

    function openModal(title, content, actions) {
        $('modal-title').innerText = title;
        $('modal-content').innerHTML = content;
        document.querySelector('.modal-actions').innerHTML = actions;
        $('edit-modal').style.display = 'flex';
    }
    function closeModal() { $('edit-modal').style.display = 'none'; }
    function showAlert(msg) { openModal("æç¤º", `<div style="padding:10px; color:var(--text-main);">${msg}</div>`, `<button onclick="closeModal()" class="btn-modal-save">ç¢ºå®š</button>`); }
    function openConfirm(msg, callback) {
        confirmCallback = callback;
        openModal("ç¢ºèª", `<div style="padding:10px; color:var(--text-main);">${msg}</div>`, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="if(confirmCallback) confirmCallback(); closeModal();" class="btn-modal-save" style="background:var(--danger);">ç¢ºå®š</button>`);
    }

    /* --- 2. DATA STRUCTURE --- */
    let tripIndex = JSON.parse(localStorage.getItem('travel_app_index')) || [];
    let currentTripId = localStorage.getItem('travel_app_current_id');
    let activeDayIdx = -1; 
    let activeGuideTab = 'guides'; 
    const GUIDE_TABS = [
        {id:'guides', icon:'ğŸ—ºï¸', name:'å°è¦½'},
        {id:'memos', icon:'ğŸ“', name:'å‚™å¿˜'},
        {id:'emergency', icon:'ğŸš¨', name:'ç·Šæ€¥'},
        {id:'notes', icon:'âš ï¸', name:'ç­†è¨˜'}
    ];
    let appData = {};

    const KYUSHU_DATA = {
        title: "ğŸŒ¸ ä¹å·è³æ«»æ‰‹å¸³",
        dates: "2026.03.26 - 03.30 | æ˜Ÿå®‡èˆªç©º",
        theme: 'sakura',
        rates: { JPY: 0.21, TWD: 1 },
        activeCurrencies: ["JPY", "TWD"],
        booking: { flights: "3/26 TPE->FUK (JX840) 10:30-13:45\n3/30 FUK->TPE (JX841) 14:45-16:30", hotels: [] },
        itinerary: [],
        guides: [], checklist: [], memos: [], emergency: [], notes: [],
        companions: ["æˆ‘"], expenses: [], tickets: [],
        shoppingList: [ { id: 1, item: "ä¸€è˜­æ‹‰éºµæ³¡éºµ", price: 2000, currency: "JPY", desc: "è¦è²·äº”ç›’", isBought: false, photo: "" } ]
    };

    const CANADA_DATA = {
        title: "ğŸ‡¨ğŸ‡¦ 2025 åŠ æ‹¿å¤§æ¥µå…‰ä¹‹æ—…",
        dates: "2025.01.23 - 02.01 | è¯èˆª+åŠ èˆª",
        theme: 'ocean',
        rates: { CAD: 23.5, TWD: 1, USD: 32 }, 
        activeCurrencies: ["CAD", "TWD"],
        booking: {
            flights: "1/23 TPE->YVR (CI022) 23:35-18:15\n1/24 YVR->YYC (AC7762) 06:30-08:55",
            hotels: [
                { name: "Banff Park Lodge", desc: "1/24 - 1/26 (2æ™š) | ç­å¤«", mapQuery: "501 Banff Avenue, Banff" },
                { name: "Coast Calgary Downtown Hotel", desc: "1/26 - 1/27 (1æ™š) | å¡åŠ åˆ©", mapQuery: "610 4th Avenue Southwest, Calgary" }
            ]
        },
        itinerary: [
             {
                date: "1/23 (å››)", weather: "âœˆï¸",
                transport: [ { time: "23:35", type: "é£›æ©Ÿ", desc: "TPE -> YVR (CI022)" } ],
                events: [ { time: "20:00", title: "å‰å¾€é£¯åº—", desc: "æ­ä¹˜æ¥é§è»Š", mapQuery: "Vancouver" } ]
            }
        ],
        shoppingList: [
            { id: 101, item: "å†°é…’ (Ice Wine)", price: 50, currency: "CAD", desc: "æ©Ÿå ´å…ç¨…åº—è²·ï¼Œæ¯äººé™å¸¶ä¸€ç“¶", isBought: false, photo: "" },
            { id: 102, item: "æ¥“ç³–é¤…ä¹¾ (Dare)", price: 5, currency: "CAD", desc: "è¶…å¸‚è²·æ¯”è¼ƒä¾¿å®œï¼Œé€åŒäº‹", isBought: false, photo: "" },
            { id: 103, item: "Roots å¸½T", price: 80, currency: "CAD", desc: "ç¶“å…¸æµ·ç‹¸Logo", isBought: false, photo: "" },
            { id: 104, item: "å§‹ç¥–é³¥å¤–å¥—", price: 600, currency: "CAD", desc: "Arc'teryx Atom LT", isBought: false, photo: "" }
        ],
        guides: [], checklist: [], memos: [], emergency: [], notes: [],
        companions: ["æˆ‘"], expenses: [], tickets: []
    };

    /* --- 3. INIT & LOAD --- */
    function initApp() {
        tripIndex = JSON.parse(localStorage.getItem('travel_app_index')) || [];
        if (tripIndex.length === 0) {
            const canadaId = 'trip_canada_default';
            localStorage.setItem('trip_data_' + canadaId, JSON.stringify(CANADA_DATA));
            tripIndex.push({ id: canadaId, title: CANADA_DATA.title });
            
            const kyushuId = 'trip_kyushu_original';
            localStorage.setItem('trip_data_' + kyushuId, JSON.stringify(KYUSHU_DATA));
            tripIndex.push({ id: kyushuId, title: KYUSHU_DATA.title });

            localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
            currentTripId = canadaId;
        } 
        
        currentTripId = localStorage.getItem('travel_app_current_id');
        if (!currentTripId || !tripIndex.find(t => t.id === currentTripId)) {
            currentTripId = tripIndex[0].id;
        }
        loadTrip(currentTripId);
    }

    function loadTrip(id) {
        currentTripId = id;
        localStorage.setItem('travel_app_current_id', id);
        const json = localStorage.getItem('trip_data_' + id);
        appData = json ? JSON.parse(json) : JSON.parse(JSON.stringify(CANADA_DATA));
        
        // Data Migration
        if(!appData.shoppingList) appData.shoppingList = [];
        if(!appData.activeCurrencies) appData.activeCurrencies = ["JPY", "TWD"];
        if(!appData.itinerary) appData.itinerary = [];
        if(!appData.expenses) appData.expenses = [];
        if(!appData.companions) appData.companions = ["æˆ‘"];
        if(!appData.rates) appData.rates = {TWD:1};
        // Transport Types Migration (Ensure it exists)
        if(!appData.transportTypes) appData.transportTypes = ['é£›æ©Ÿ','å·´å£«','ç«è»Š','ç§Ÿè»Š','åœ°éµ','Uber','æ¥é§è»Š'];

        appData.itinerary.forEach(d => { if(!d.transport) d.transport = []; });
        
        // Ensure activeCurrencies contains keys from rates if empty
        if(appData.activeCurrencies.length === 0 && appData.rates) {
            appData.activeCurrencies = Object.keys(appData.rates);
        }

        refreshAllUI();
    }

    function saveData() {
        try {
            localStorage.setItem('trip_data_' + currentTripId, JSON.stringify(appData));
            const idx = tripIndex.findIndex(t => t.id === currentTripId);
            if (idx !== -1 && tripIndex[idx].title !== appData.title) {
                tripIndex[idx].title = appData.title;
                localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
            }
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                showAlert("âš ï¸ å„²å­˜ç©ºé–“å·²æ»¿ï¼");
            }
        }
    }

    function refreshAllUI() { 
        setTheme(appData.theme || 'sakura'); 
        renderHeader(); 
        renderBooking(); 
        renderItinerary(); 
        renderGuideView(); 
        renderExpenses(); 
        refreshLists();   
        renderShopping(); 
        renderTickets(); 
        initWallet(); 
        fetchHomeWeather();
    }

    /* --- THEME & HEADER --- */
    function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); appData.theme = theme; saveData(); }
    function renderHeader() { $('app-title').innerText = appData.title; $('app-dates').innerText = appData.dates; }
    function editHeader() { openModal("ç·¨è¼¯æ‰‹å¸³è³‡è¨Š", `<div class="form-group"><label class="form-label">æ¨™é¡Œ</label><input id="et" value="${appData.title}" class="form-input"></div><div class="form-group"><label class="form-label">æ—¥æœŸ</label><input id="ed" value="${appData.dates}" class="form-input"></div>`, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="appData.title=$('et').value;appData.dates=$('ed').value;renderHeader();saveData();closeModal()" class="btn-modal-save">å„²å­˜</button>`); }
    function switchTab(tabId) {
        document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active'));
        $(tabId+'-view').classList.add('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        const tabBtn = document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`);
        if(tabBtn) tabBtn.classList.add('active');
        window.scrollTo({top: 0, behavior: 'smooth'});
        if(tabId === 'guide') renderGuideView();
        if(tabId === 'shopping') renderShopping();
    }
    
    // TRIP MANAGER
    function openTripManager() {
        const listHtml = tripIndex.map(t => `<div class="list-item-card" onclick="loadTrip('${t.id}');closeModal();" style="cursor:pointer; ${t.id===currentTripId?'border:2px solid var(--primary)':''}"><div style="flex:1;"><b>${t.title}</b></div>${tripIndex.length>1?`<button onclick="event.stopPropagation();deleteTrip('${t.id}')" style="color:red;border:none;background:none;">ğŸ—‘ï¸</button>`:''}</div>`).join('');
        openModal("æˆ‘çš„æ‰‹å¸³æœ¬", listHtml + `<button onclick="createNewTrip()" class="btn-add-block">+ æ–°å¢æ‰‹å¸³</button>`, `<button onclick="closeModal()" class="btn-modal-cancel">é—œé–‰</button>`);
    }
    function createNewTrip() {
        const id = 'trip_' + Date.now();
        const newTrip = { ...CANADA_DATA, title: "æ–°æ—…ç¨‹", dates: "", expenses: [], itinerary: [] };
        localStorage.setItem('trip_data_' + id, JSON.stringify(newTrip));
        tripIndex.push({ id: id, title: "æ–°æ—…ç¨‹" });
        localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
        loadTrip(id); closeModal();
    }
    function deleteTrip(id) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤æ‰‹å¸³ï¼Ÿ")) {
            tripIndex = tripIndex.filter(t => t.id !== id);
            localStorage.removeItem('trip_data_' + id);
            localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
            loadTrip(tripIndex[0].id); closeModal();
        }
    }

    /* --- SHOPPING --- */
    function renderShopping() {
        const list = appData.shoppingList || [];
        let totalEst = 0; let boughtEst = 0;
        const html = list.map((item, i) => {
            const rate = appData.rates[item.currency] || 1;
            const priceTwd = Math.round(item.price * rate);
            totalEst += priceTwd;
            if(item.isBought) boughtEst += priceTwd;
            return `<div class="shop-card ${item.isBought ? 'bought' : ''}">
                <div class="shop-img-box" onclick="document.getElementById('shop-file-${i}').click()">${item.photo ? `<img src="${item.photo}">` : 'ğŸ“·'}</div>
                <input type="file" id="shop-file-${i}" style="display:none" accept="image/*" onchange="updateShopPhoto(${i}, this)">
                <div class="shop-info" onclick="openShoppingModal(${i})">
                    <div class="shop-title"><input type="checkbox" ${item.isBought?'checked':''} onclick="event.stopPropagation(); toggleShopBought(${i})"><span style="${item.isBought?'text-decoration:line-through':''}">${item.item}</span></div>
                    <div class="shop-price">${item.price} ${item.currency} <span style="font-size:11px;color:#999;">(â‰ˆNT$${priceTwd})</span></div>
                    <div class="shop-desc">${item.desc || ''}</div>
                </div>
                <button onclick="deleteShopItem(${i})" style="border:none; background:none; padding:10px; color:#999;">âœ•</button>
            </div>`;
        }).join('');
        $('shopping-list-container').innerHTML = html || '<div style="text-align:center; padding:30px; opacity:0.5;">å°šç„¡è³¼ç‰©æ¸…å–®</div>';
        $('shop-total').innerText = "NT$ " + totalEst.toLocaleString();
        $('shop-bought').innerText = "NT$ " + boughtEst.toLocaleString();
    }
    function openShoppingModal(idx=-1) {
        const d = idx>=0 ? appData.shoppingList[idx] : { item:'', price:'', currency:'CAD', desc:'', photo:'', isBought:false };
        const html = `<div class="form-group"><label class="form-label">å•†å“åç¨±</label><input id="sp-name" value="${d.item}" class="form-input"></div><div style="display:flex; gap:10px;"><div style="flex:1"><label class="form-label">é ä¼°åƒ¹æ ¼</label><input id="sp-price" type="number" value="${d.price}" class="form-input"></div><div style="width:100px"><label class="form-label">å¹£åˆ¥</label><select id="sp-curr" class="form-select">${appData.activeCurrencies.map(c=>`<option ${c===d.currency?'selected':''}>${c}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">å‚™è¨»</label><input id="sp-desc" value="${d.desc}" class="form-input"></div>`;
        openModal(idx>=0?"ç·¨è¼¯å•†å“":"æ–°å¢å•†å“", html, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="saveShoppingItem(${idx})" class="btn-modal-save">å„²å­˜</button>`);
    }
    function saveShoppingItem(idx) {
        const val = { id: idx>=0 ? appData.shoppingList[idx].id : Date.now(), item: $('sp-name').value, price: parseFloat($('sp-price').value) || 0, currency: $('sp-curr').value, desc: $('sp-desc').value, photo: idx>=0 ? appData.shoppingList[idx].photo : '', isBought: idx>=0 ? appData.shoppingList[idx].isBought : false };
        if(idx>=0) appData.shoppingList[idx] = val; else appData.shoppingList.push(val);
        saveData(); renderShopping(); closeModal();
    }
    function toggleShopBought(idx) { appData.shoppingList[idx].isBought = !appData.shoppingList[idx].isBought; saveData(); renderShopping(); }
    function deleteShopItem(idx) { if(confirm("åˆªé™¤æ­¤å•†å“ï¼Ÿ")) { appData.shoppingList.splice(idx, 1); saveData(); renderShopping(); } }
    function updateShopPhoto(idx, input) { compressImage(input, null, null, (base64) => { appData.shoppingList[idx].photo = base64; saveData(); renderShopping(); }); }

    /* --- BOOKING (Boarding Pass Style + Hotel Doorplate) --- */
    
    // 1. è³‡æ–™è½‰æ›å·¥å…· (å°‡èˆŠçš„å­—ä¸²æ ¼å¼è½‰ç‚ºé™£åˆ—)
    function migrateFlightData() {
        if (typeof appData.booking.flights === 'string') {
            const text = appData.booking.flights;
            const newFlights = [];
            if (text) {
                const lines = text.split('\n');
                lines.forEach(line => {
                    const regex = /^(\S+)\s+(\w+)->(\w+)\s+\((.*?)\)\s+(.*)$/;
                    const match = line.trim().match(regex);
                    if (match) {
                        const [_, date, from, to, flight, time] = match;
                        newFlights.push({ date, from, to, flight, time });
                    }
                });
            }
            appData.booking.flights = newFlights;
            saveData();
        }
        // ç¢ºä¿æ˜¯é™£åˆ—
        if (!Array.isArray(appData.booking.flights)) {
            appData.booking.flights = [];
        }
    }

    // 2. æ¸²æŸ“ç•«é¢ (å·²ä¿®æ­£åˆªé™¤æŒ‰éˆ•ä½ç½®)
    function renderBooking() {
        // å…ˆåŸ·è¡Œè³‡æ–™é·ç§»æª¢æŸ¥
        migrateFlightData();

        const flights = appData.booking.flights;
        let html = '';
        
        if (flights.length > 0) {
            html = flights.map((f, i) => `
            <div class="bp-card" onclick="openFlightManager(${i})">
                <div class="bp-header">
                    <span>BOARDING PASS</span>
                    <span>${f.flight}</span>
                </div>
                <div class="bp-body">
                    <div class="bp-route-row">
                        <div class="bp-code">${f.from}</div>
                        <div class="bp-icon">
                            âœˆï¸
                            <span>to</span>
                        </div>
                        <div class="bp-code">${f.to}</div>
                    </div>
                    <div class="bp-details-row">
                        <div><div class="bp-label">DATE</div><div class="bp-val">${f.date}</div></div>
                        <div style="text-align:right"><div class="bp-label">TIME</div><div class="bp-val">${f.time}</div></div>
                    </div>
                </div>
                <div class="bp-footer">
                    <div class="bp-barcode">${f.flight}${f.from}${f.to}</div>
                    <button class="bp-delete-btn" onclick="event.stopPropagation(); deleteFlight(${i});">ğŸ—‘ï¸</button>
                </div>
            </div>`).join('');
        } else {
            html = `<div style="text-align:center; padding:30px; color:#ccc; border: 2px dashed #eee; border-radius:16px; margin-bottom:15px;">å°šç„¡èˆªç­<br>é»æ“Šä¸Šæ–¹ã€Œæ–°å¢ã€æŒ‰éˆ•åŠ å…¥</div>`;
        }
        
        // æ›´æ–° HTML
        $('booking-flights').innerHTML = html;
        
        // RENDER HOTELS (é€™éƒ¨åˆ†ä¿æŒä¸è®Š)
        $('booking-hotels-container').innerHTML = appData.booking.hotels.map((h,i)=>`
            <div class="hotel-doorplate">
                <div class="hotel-screw screw-tl"></div>
                <div class="hotel-screw screw-tr"></div>
                <div class="hotel-screw screw-bl"></div>
                <div class="hotel-screw screw-br"></div>
                
                <div class="hotel-icon-badge">ğŸ¨</div>
                <div class="hotel-info-plate">
                    <div class="hotel-name-plate">${h.name}</div>
                    <div class="hotel-desc-plate">${h.desc}</div>
                    ${h.mapQuery ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.mapQuery)}" target="_blank" class="btn-action" style="margin-top:6px; align-self:flex-start;">ğŸ“ åœ°åœ–</a>` : ''}
                </div>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <button onclick="openHotelModal(${i})" class="btn-pill btn-secondary" style="width:30px;height:30px;justify-content:center;">âœï¸</button>
                    <button onclick="appData.booking.hotels.splice(${i},1);saveData();renderBooking();" class="btn-pill btn-secondary" style="width:30px;height:30px;justify-content:center;color:var(--danger)">âœ•</button>
                </div>
            </div>
        `).join('');
    }
    // 3. é–‹å•Ÿç·¨è¼¯/æ–°å¢è¦–çª— (æ¢åˆ—å¼è¼¸å…¥)
    function openFlightManager(idx) {
        // å–å¾—é è¨­å€¼æˆ–ç¾æœ‰å€¼
        const f = idx >= 0 ? appData.booking.flights[idx] : { flight: '', from: 'TPE', to: '', date: '', time: '' };
        
        const html = `
            <div class="form-group">
                <label class="form-label">èˆªç­ä»£è™Ÿ (Flight No.)</label>
                <input id="bf-flight" value="${f.flight}" class="form-input" placeholder="ä¾‹ï¼šJX800">
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group">
                    <label class="form-label">å‡ºç™¼åœ° (From)</label>
                    <input id="bf-from" value="${f.from}" class="form-input" placeholder="ä¾‹ï¼šTPE">
                </div>
                <div class="form-group">
                    <label class="form-label">ç›®çš„åœ° (To)</label>
                    <input id="bf-to" value="${f.to}" class="form-input" placeholder="ä¾‹ï¼šNRT">
                </div>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group">
                    <label class="form-label">æ—¥æœŸ (Date)</label>
                    <input id="bf-date" value="${f.date}" class="form-input" placeholder="ä¾‹ï¼š1/23">
                </div>
                <div class="form-group">
                    <label class="form-label">æ™‚é–“ (Time)</label>
                    <input id="bf-time" value="${f.time}" class="form-input" placeholder="ä¾‹ï¼š10:30-14:00">
                </div>
            </div>
        `;
        
        openModal(
            idx >= 0 ? "ç·¨è¼¯èˆªç­" : "æ–°å¢èˆªç­", 
            html, 
            `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button>
             <button onclick="saveFlight(${idx})" class="btn-modal-save">å„²å­˜</button>`
        );
    }

    // 4. å„²å­˜èˆªç­é‚è¼¯
    function saveFlight(idx) {
        const newFlight = {
            flight: $('bf-flight').value.toUpperCase(),
            from: $('bf-from').value.toUpperCase(),
            to: $('bf-to').value.toUpperCase(),
            date: $('bf-date').value,
            time: $('bf-time').value
        };

        if (idx >= 0) {
            appData.booking.flights[idx] = newFlight;
        } else {
            appData.booking.flights.push(newFlight);
        }
        
        saveData();
        renderBooking();
        closeModal();
    }

    // 5. åˆªé™¤èˆªç­é‚è¼¯
    function deleteFlight(idx) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤èˆªç­è³‡è¨Šï¼Ÿ")) {
            appData.booking.flights.splice(idx, 1);
            saveData();
            renderBooking();
        }
    }

    function openHotelModal(idx=-1) {
        const d = idx>=0 ? appData.booking.hotels[idx] : {name:'', desc:'', mapQuery:''};
        openModal("ä½å®¿", `<div class="form-group"><input id="hn" value="${d.name}" class="form-input" placeholder="åç¨±"></div><div class="form-group"><input id="hd" value="${d.desc}" class="form-input" placeholder="å‚™è¨»"></div><div class="form-group"><input id="hm" value="${d.mapQuery}" class="form-input" placeholder="åœ°åœ–é—œéµå­—"></div>`, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="const v={name:$('hn').value,desc:$('hd').value,mapQuery:$('hm').value}; if(${idx}>=0) appData.booking.hotels[${idx}]=v; else appData.booking.hotels.push(v); saveData(); renderBooking(); closeModal();" class="btn-modal-save">å„²å­˜</button>`);
    }

    /* --- ITINERARY --- */
    function renderItinerary() {
        let s = `<div class="day-tab-item ${activeDayIdx===-1?'active':''}" onclick="switchDay(-1)"><div class="day-tab-num">ğŸ“‹</div><div class="day-tab-label">è¡Œå‰</div></div>`;
        s += appData.itinerary.map((d,i)=>`<div class="day-tab-item ${i===activeDayIdx?'active':''}" onclick="switchDay(${i})"><div class="day-tab-num">D${i+1}</div><div class="day-tab-label">${d.date.split('(')[0].substring(0,6)}</div></div>`).join('');
        $('itinerary-day-selector').innerHTML = s;
        $('btn-add-day').style.display = activeDayIdx === -1 ? 'none' : 'block';

        if(activeDayIdx === -1) {
            $('itinerary-active-content').innerHTML = `<div class="card"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><h3>âœ… è¡Œå‰æ¸…å–®</h3><button onclick="addListItem('checklist')" class="btn-pill btn-secondary">ï¼‹</button></div>${appData.checklist.map((item,i)=>`<div class="list-item-card"><input type="checkbox" ${item.checked?'checked':''} onchange="appData.checklist[${i}].checked=this.checked;saveData();renderItinerary()"><div style="flex:1;${item.checked?'text-decoration:line-through;color:#ccc':''}">${item.text}</div><button onclick="appData.checklist.splice(${i},1);saveData();renderItinerary()" style="border:none;background:none;color:#999">âœ•</button></div>`).join('')}</div>`;
            return;
        }

        const d = appData.itinerary[activeDayIdx];
        if(!d) { $('itinerary-active-content').innerHTML = ''; return; }
        
        let html = `
        <div class="day-weather-mini" onclick="editDay(${activeDayIdx})">
            <div>
                <h3><span class="day-weather-icon">${d.weather && d.weather.includes('â˜€ï¸') ? 'â˜€ï¸' : (d.weather && d.weather.includes('â˜ï¸') ? 'â˜ï¸' : 'ğŸŒ')}</span> ${d.weather||'é»æ“Šè¨­å®šå¤©æ°£'}</h3>
                <div style="font-size:12px; opacity:0.8; margin-top:4px;">${d.date||'æ—¥æœŸæœªå®š'}</div>
            </div>
            <button class="btn-pill btn-secondary">âœï¸ ç·¨è¼¯</button>
        </div>
        
        <div class="daily-transport-card"><div class="daily-transport-header"><b>ğŸšŒ æ¯æ—¥äº¤é€š</b><button onclick="openDailyTransportEdit()" style="background:rgba(0,0,0,0.05);border:none;color:var(--text-main);border-radius:50%;width:28px;height:28px;">âœï¸</button></div>${(d.transport||[]).map(t=>`
            <div class="daily-transport-item">
                <div style="display:flex;align-items:center;gap:10px;width:100%;">
                    <div class="transport-time">${t.depTime || '--:--'} â ${t.arrTime || '--:--'}</div>
                    <div style="flex:1">
                        <div class="transport-route"><span style="background:${t.type==='é£›æ©Ÿ'?'#e3f2fd':'#fff3e0'};padding:2px 6px;border-radius:4px;font-size:11px;">${t.type}</span> ${t.from} â ${t.to}</div>
                    </div>
                    <div class="transport-duration">${calculateDuration(t.depTime, t.arrTime)}</div>
                </div>
            </div>`).join('')||'<div style="text-align:center;font-size:12px;opacity:0.7;padding:5px;">ï¼‹ æ–°å¢äº¤é€š</div>'}</div>
        <div class="it-card-container">${d.events.map(e=>`<div class="it-card ${/flight|é£›æ©Ÿ/.test(e.title)?'special-flight':''}"><div class="it-header"><div class="it-time">${e.time}</div></div><div class="it-body"><div class="it-icon-box">${/flight/.test(e.title)?'âœˆï¸':'ğŸ“'}</div><div class="it-info"><div class="it-title">${e.title}</div><div class="it-desc">${e.desc}</div>${e.mapQuery?`<div class="it-links"><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.mapQuery)}" target="_blank" class="btn-action">åœ°åœ–</a></div>`:''}</div></div></div>`).join('')}</div>`;
        $('itinerary-active-content').innerHTML = html;
    }
    
    function calculateDuration(start, end) {
        if(!start || !end) return '';
        const [h1, m1] = start.split(':').map(Number);
        const [h2, m2] = end.split(':').map(Number);
        let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
        if(diff < 0) diff += 24 * 60; // Cross midnight
        const h = Math.floor(diff / 60);
        const m = diff % 60;
        return (h > 0 ? `${h}h ` : '') + `${m}m`;
    }

    function refreshLists() { if(activeDayIdx === -1 && document.getElementById('itinerary-view').classList.contains('active')) renderItinerary(); if(document.getElementById('guide-view').classList.contains('active')) renderGuideView(); }
    function switchDay(i) { activeDayIdx=i; renderItinerary(); }
    function addDay() { appData.itinerary.push({date:"New Day", weather:"", events:[], transport:[]}); activeDayIdx=appData.itinerary.length-1; saveData(); renderItinerary(); }
    function editDay(i) {
        const d = appData.itinerary[i];
        openModal("ç·¨è¼¯", `<div style="display:flex;gap:5px;margin-bottom:10px;"><input id="ed-d" value="${d.date}" class="form-input" placeholder="æ—¥æœŸ"><input id="ed-w" value="${d.weather}" class="form-input" placeholder="å¤©æ°£è³‡è¨Š"><button onclick="fetchRealWeather()" class="btn-icon-only" id="btn-gw">ğŸŒ</button></div><div id="ev-list">${d.events.map(e=>genEvRow(e)).join('')}</div><button onclick="$('ev-list').insertAdjacentHTML('beforeend', genEvRow())" class="btn-add-block">+ è¡Œç¨‹</button><button onclick="if(confirm('åˆªé™¤?')) { appData.itinerary.splice(${i},1); activeDayIdx--; saveData(); renderItinerary(); closeModal(); }" style="width:100%;margin-top:10px;color:red;border:none;background:none;">åˆªé™¤æ•´å¤©</button>`, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="saveDay(${i})" class="btn-modal-save">å„²å­˜</button>`);
    }
    
    // --- REAL WEATHER LOGIC ---
    const POI_MAPPING = { "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´": "Taoyuan", "TPE": "Taoyuan", "NRT": "Narita", "KIX": "Osaka", "YVR": "Vancouver", "YYC": "Calgary", "YZF": "Yellowknife", "Banff": "Banff" };
    async function getGeoLocation(query) { let searchTerm = POI_MAPPING[query] || query; const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(searchTerm)}&count=1&format=json`); return await res.json(); }
    
    window.fetchRealWeather = async function() { 
        const input = document.getElementById('ed-w'); 
        const btn = document.getElementById('btn-gw'); 
        const modalContent = document.getElementById('modal-content'); 
        
        // Try getting location from inputs in the modal
        let query = modalContent.querySelector('.ew')?.value || modalContent.querySelector('.em')?.value || modalContent.querySelector('.eti')?.value || ""; 
        
        // If modal inputs empty, try existing data
        if(!query && appData.itinerary[activeDayIdx] && appData.itinerary[activeDayIdx].events.length > 0) {
             query = appData.itinerary[activeDayIdx].events[0].weatherQuery || appData.itinerary[activeDayIdx].events[0].mapQuery || appData.itinerary[activeDayIdx].events[0].title;
        }

        if(!query) { alert("è«‹å…ˆè¼¸å…¥è¡Œç¨‹åœ°é»ä»¥æŠ“å–å¤©æ°£"); return; } 
        
        btn.innerText = "â³"; 
        try { 
            const geo = await getGeoLocation(query); 
            if(!geo.results) throw new Error("ç„¡çµæœ"); 
            const {latitude, longitude, name} = geo.results[0]; 
            const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto`)).json(); 
            let icon = w.current_weather.weathercode < 3 ? "â˜€ï¸" : "â˜ï¸"; 
            input.value = `${icon} ${name} ${w.current_weather.temperature}Â°C`; 
        } catch(e) { 
            console.error(e); 
            input.value = query; 
            alert("æ‰¾ä¸åˆ°æ­¤åœ°é»å¤©æ°£");
        } finally { 
            btn.innerText = "ğŸŒ"; 
        } 
    };

    window.fetchHomeWeather = async function() { 
        const container = document.getElementById('weekly-weather-container'); 
        const locName = document.getElementById('weather-loc-name');
        
        if(!container || !locName) return;

        let query = "Taipei";
        if(appData.itinerary.length > 0 && appData.itinerary[0].events.length > 0) {
             const ev = appData.itinerary[0].events[0];
             query = ev.weatherQuery || ev.mapQuery || "Taipei";
        } else if (appData.booking.hotels.length > 0) {
             query = appData.booking.hotels[0].mapQuery || "Taipei";
        }

        try { 
            const geo = await getGeoLocation(query); 
            if(geo.results) { 
                const {latitude, longitude, name} = geo.results[0]; 
                locName.innerText = name; 
                const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min&timezone=auto`)).json(); 
                if(w.daily) { 
                    container.innerHTML = w.daily.time.map((t,i) => { 
                        const feelMax = Math.round(w.daily.apparent_temperature_max[i]); 
                        return `<div class="weather-day">
                            <div style="font-size:12px; margin-bottom:4px;">${new Date(t).toLocaleDateString('zh-TW',{weekday:'short'})}</div>
                            <div class="weather-icon">${w.daily.weathercode[i]<3?'â˜€ï¸':'â˜ï¸'}</div>
                            <div style="font-size:14px; font-weight:bold;">${Math.round(w.daily.temperature_2m_max[i])}Â°</div>
                            <div class="clothing-advice">${getClothingAdvice(feelMax)}</div>
                        </div>`; 
                    }).join(''); 
                } 
            } 
        } catch(e) {
            console.error(e);
            container.innerHTML = `<div style="width:100%;text-align:center;opacity:0.6;padding:10px;">ç„¡æ³•è¼‰å…¥å¤©æ°£</div>`;
        } 
    };
    
    function getClothingAdvice(temp) { if (temp >= 30) return "çŸ­è¢–"; if (temp >= 25) return "é€æ°£"; if (temp >= 20) return "è–„å¤–å¥—"; if (temp >= 15) return "å¤¾å…‹"; if (temp >= 10) return "æ¯›è¡£"; if (temp >= 5) return "ç¾½çµ¨"; return "é‡ä¿æš–"; }

    function genEvRow(e={time:'',title:'',desc:'',mapQuery:'',weatherQuery:''}) { 
        return `
        <div class="event-edit-row">
            <div class="event-edit-row-header">
                <input class="form-input et" value="${e.time}" placeholder="æ™‚é–“" style="width:80px">
                <input class="form-input eti" value="${e.title}" placeholder="æ¨™é¡Œ" style="flex:1">
            </div>
            <textarea class="form-textarea ed" placeholder="å‚™è¨»/æè¿°" style="margin-bottom:10px;height:60px;">${e.desc}</textarea>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; align-items:end;">
                <div>
                    <label style="font-size:10px;color:#888;">åœ°åœ–å®šä½</label>
                    <input class="form-input em" value="${e.mapQuery}" placeholder="Google Maps é—œéµå­—">
                </div>
                <div>
                    <label style="font-size:10px;color:#888;">å¤©æ°£åœ°é»</label>
                    <input class="form-input ew" value="${e.weatherQuery}" placeholder="åŸå¸‚åç¨± (è‹±æ–‡)">
                </div>
            </div>
            <div style="margin-top:5px; text-align:right;">
                 <a href="#" onclick="event.preventDefault(); const q = this.parentElement.previousElementSibling.querySelector('.em').value; if(q) window.open('https://www.google.com/maps/search/?api=1&query='+encodeURIComponent(q), '_blank'); else alert('è«‹å…ˆè¼¸å…¥åœ°åœ–é—œéµå­—');" style="font-size:12px; color:var(--primary);">ğŸ“ æ¸¬è©¦åœ°åœ–</a>
            </div>
            <button onclick="this.closest('.event-edit-row').remove()" style="position:absolute; top:10px; right:10px; color:red; border:none; background:transparent; font-size:18px;">âœ•</button>
        </div>`; 
    }
    function saveDay(i) {
        const evs = Array.from(document.querySelectorAll('.event-edit-row')).map(r=>({
            time:r.querySelector('.et').value, 
            title:r.querySelector('.eti').value, 
            desc:r.querySelector('.ed').value, 
            mapQuery:r.querySelector('.em').value, 
            weatherQuery:r.querySelector('.ew').value
        })).sort((a,b)=>a.time.localeCompare(b.time));
        appData.itinerary[i] = { ...appData.itinerary[i], date:$('ed-d').value, weather:$('ed-w').value, events:evs };
        saveData(); renderItinerary(); closeModal(); if(i===0) fetchHomeWeather();
    }
    
    // --- TRANSPORT LOGIC UPDATED ---
    function openDailyTransportEdit() {
        const d = appData.itinerary[activeDayIdx];
        let html = `<div id="tr-list" style="max-height:300px;overflow-y:auto;margin-bottom:10px;">`;
        
        (d.transport||[]).forEach((t, i) => {
            html += generateTransportRow(t, i);
        });
        
        html += `</div>
        <button onclick="addTransportRow()" class="btn-add-block" style="margin-bottom:15px;">+ æ–°å¢äº¤é€š</button>
        <div style="text-align:right; font-size:12px; color:#666;">
            <button onclick="openTransportTypeManager()" style="border:none;background:none;color:var(--primary);cursor:pointer;">âš™ï¸ ç®¡ç†äº¤é€šå·¥å…·é¸é …</button>
        </div>`;
        
        openModal("ç·¨è¼¯ç•¶æ—¥äº¤é€š", html, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="saveDailyTransport()" class="btn-modal-save">å„²å­˜</button>`);
    }

    function generateTransportRow(t={}, i=null) {
        const typeOptions = appData.transportTypes.map(type => `<option value="${type}" ${t.type === type ? 'selected' : ''}>${type}</option>`).join('');
        return `
        <div class="event-edit-row tr-row">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:5px;">
                <div><label class="form-label">å‡ºç™¼æ™‚é–“</label><input type="time" class="form-input tt-dep" value="${t.depTime||''}" onchange="updateDurationDisplay(this)"></div>
                <div><label class="form-label">åˆ°é”æ™‚é–“</label><input type="time" class="form-input tt-arr" value="${t.arrTime||''}" onchange="updateDurationDisplay(this)"></div>
            </div>
            <div style="text-align:right; font-size:11px; color:var(--primary); margin-bottom:5px;" class="duration-disp">${calculateDuration(t.depTime, t.arrTime)}</div>
            <div style="margin-bottom:5px;">
                <label class="form-label">äº¤é€šå·¥å…·</label>
                <select class="form-select tt-type">${typeOptions}</select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input class="form-input tt-from" value="${t.from||''}" placeholder="å‡ºç™¼åœ°">
                <input class="form-input tt-to" value="${t.to||''}" placeholder="ç›®çš„åœ°">
            </div>
            <button onclick="this.closest('.tr-row').remove()" style="position:absolute; top:5px; right:5px; color:red; border:none; background:transparent;">âœ•</button>
        </div>`;
    }

    window.addTransportRow = function() {
        const list = document.getElementById('tr-list');
        list.insertAdjacentHTML('beforeend', generateTransportRow());
    };

    window.updateDurationDisplay = function(input) {
        const row = input.closest('.tr-row');
        const dep = row.querySelector('.tt-dep').value;
        const arr = row.querySelector('.tt-arr').value;
        row.querySelector('.duration-disp').innerText = calculateDuration(dep, arr);
    };

    window.saveDailyTransport = function() {
        const rows = document.querySelectorAll('.tr-row');
        const newTransports = Array.from(rows).map(row => ({
            depTime: row.querySelector('.tt-dep').value,
            arrTime: row.querySelector('.tt-arr').value,
            type: row.querySelector('.tt-type').value,
            from: row.querySelector('.tt-from').value,
            to: row.querySelector('.tt-to').value
        })).filter(t => t.depTime || t.type || t.from); // Filter empty rows slightly
        
        appData.itinerary[activeDayIdx].transport = newTransports.sort((a,b) => (a.depTime||'').localeCompare(b.depTime||''));
        saveData();
        renderItinerary();
        closeModal();
    };

    window.openTransportTypeManager = function() {
        let html = `<div id="type-list" style="max-height:200px; overflow-y:auto; margin-bottom:10px;">`;
        appData.transportTypes.forEach(type => {
            html += `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;">
                <span>${type}</span>
                <button onclick="removeTransportType('${type}')" class="btn-delete-icon" style="width:20px;height:20px;font-size:12px;">âœ•</button>
            </div>`;
        });
        html += `</div>
        <div style="display:flex; gap:5px;">
            <input id="new-type-input" class="form-input" placeholder="æ–°äº¤é€šå·¥å…·...">
            <button onclick="addTransportType()" class="btn-secondary" style="padding:5px 10px;">+</button>
        </div>`;
        
        openModal("ç®¡ç†äº¤é€šå·¥å…·", html, `<button onclick="openDailyTransportEdit()" class="btn-modal-save">è¿”å›</button>`);
    };

    window.addTransportType = function() {
        const val = document.getElementById('new-type-input').value.trim();
        if(val && !appData.transportTypes.includes(val)) {
            appData.transportTypes.push(val);
            saveData();
            openTransportTypeManager(); // Refresh
        }
    };

    window.removeTransportType = function(val) {
        if(confirm(`åˆªé™¤ ${val}?`)) {
            appData.transportTypes = appData.transportTypes.filter(t => t !== val);
            saveData();
            openTransportTypeManager();
        }
    };


    /* --- WALLET & EXPENSES (UPDATED) --- */
    const EXP_CATS = { 
        'food': {icon:'ğŸ”', name:'é¤é£²'}, 'transport': {icon:'ğŸš—', name:'äº¤é€š'}, 
        'shop': {icon:'ğŸ›ï¸', name:'è³¼ç‰©'}, 'stay': {icon:'ğŸ¨', name:'ä½å®¿'}, 
        'ticket': {icon:'ğŸ«', name:'é–€ç¥¨'}, 'other': {icon:'ğŸ’¸', name:'å…¶ä»–'} 
    };

    function initWallet() {
        const sel = $('calc-currency');
        if(sel) {
            // Ensure dropdown options match activeCurrencies
            const options = appData.activeCurrencies.map(c => `<option value="${c}">${c}</option>`).join('');
            if(sel.innerHTML !== options) {
                sel.innerHTML = options;
                sel.value = appData.activeCurrencies[0];
            }
            manualRateUpdate();
        }
    }
    
    function manualRateUpdate() {
        const curr = $('calc-currency').value;
        const rate = appData.rates[curr] || 1;
        $('calc-rate').value = rate;
        updateCalc();
    }
    
    function updateCalc() {
        try {
            const input = $('calc-input').value;
            if(!input) { $('calc-result-twd').innerText = "0"; return; }
            const res = Function('"use strict";return (' + input + ')')();
            const rate = parseFloat($('calc-rate').value) || 1;
            $('calc-result-twd').innerText = Math.round(res * rate).toLocaleString();
        } catch(e) {}
    }
    
    function addExpenseFromCalc() {
        const raw = $('calc-input').value;
        if(!raw) return;
        try {
            const amt = Function('"use strict";return (' + raw + ')')();
            const curr = $('calc-currency').value;
            openAddExpenseModal(-1, {amount: amt, currency: curr});
            $('calc-input').value = ''; updateCalc();
        } catch(e) { alert("ç®—å¼éŒ¯èª¤"); }
    }

    /* --- NEW: CURRENCY MANAGER --- */
    window.openCurrencyManager = function() {
        let html = `<div style="margin-bottom:15px; font-size:12px; color:#666;">è¨­å®šå¤–å¹£å° TWD çš„åŒ¯ç‡ (1 å¤–å¹£ = ? TWD)</div>`;
        html += `<div id="currency-list" style="max-height:200px; overflow-y:auto; margin-bottom:10px;">`;
        
        appData.activeCurrencies.forEach((curr) => {
            const rate = appData.rates[curr] || 1;
            const isBase = curr === 'TWD';
            html += `
            <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                <input type="text" value="${curr}" class="form-input" style="width:60px; text-align:center; font-weight:bold;" readonly disabled>
                <input type="number" step="0.0001" value="${rate}" class="form-input" style="flex:1;" onchange="updateCurrencyRate('${curr}', this.value)" ${isBase ? 'disabled' : ''}>
                ${!isBase ? `<button onclick="removeCurrency('${curr}')" class="btn-delete-icon" style="background:#eee; border-radius:4px;">âœ•</button>` : ''}
            </div>`;
        });
        html += `</div>`;
        
        html += `<div style="border-top:1px dashed #ccc; padding-top:10px; display:flex; gap:5px;">
            <input id="new-curr-code" class="form-input" placeholder="å¹£åˆ¥ (å¦‚ USD)" style="width:100px; text-transform:uppercase;">
            <input id="new-curr-rate" type="number" step="0.0001" class="form-input" placeholder="åŒ¯ç‡" style="flex:1;">
            <button onclick="addNewCurrency()" class="btn-pill btn-secondary" style="padding:0 15px;">+</button>
        </div>`;

        openModal("åŒ¯ç‡ç®¡ç†", html, `<button onclick="closeModal(); initWallet();" class="btn-modal-save">å®Œæˆ</button>`);
    };

    window.updateCurrencyRate = function(code, val) {
        appData.rates[code] = parseFloat(val);
        saveData();
    };

    window.removeCurrency = function(code) {
        if(confirm(`åˆªé™¤ ${code}?`)) {
            appData.activeCurrencies = appData.activeCurrencies.filter(c => c !== code);
            delete appData.rates[code];
            saveData();
            openCurrencyManager(); // Refresh modal
        }
    };

    window.addNewCurrency = function() {
        const code = document.getElementById('new-curr-code').value.trim().toUpperCase();
        const rate = parseFloat(document.getElementById('new-curr-rate').value);
        if(!code || !rate) { alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š"); return; }
        if(appData.activeCurrencies.includes(code)) { alert("å¹£åˆ¥å·²å­˜åœ¨"); return; }
        
        appData.activeCurrencies.push(code);
        appData.rates[code] = rate;
        saveData();
        openCurrencyManager();
    };

    /* --- NEW: COMPANION MANAGER --- */
    window.openCompanionsModal = function() {
        let html = `<div id="companion-list" style="max-height:250px; overflow-y:auto; margin-bottom:15px;">`;
        appData.companions.forEach((name, index) => {
            html += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:#f9f9f9; border-radius:8px; margin-bottom:5px; border:1px solid #eee;">
                <span id="comp-name-${index}" style="font-weight:bold; margin-left:5px;">${name}</span>
                <div style="display:flex; gap:5px;">
                    <button onclick="editCompanion(${index})" class="btn-edit" style="font-size:14px;">âœï¸</button>
                    <button onclick="deleteCompanion(${index})" class="btn-delete-icon" style="font-size:14px;">âœ•</button>
                </div>
            </div>`;
        });
        html += `</div>`;
        
        html += `<div style="display:flex; gap:5px;">
            <input id="new-comp-name" class="form-input" placeholder="è¼¸å…¥æ—…ä¼´åå­—...">
            <button onclick="addCompanion()" class="btn-modal-save" style="width:auto; padding:0 15px;">æ–°å¢</button>
        </div>`;

        openModal("ç®¡ç†æ—…ä¼´", html, `<button onclick="closeModal()" class="btn-modal-cancel">é—œé–‰</button>`);
    };

    window.addCompanion = function() {
        const name = document.getElementById('new-comp-name').value.trim();
        if(!name) return;
        appData.companions.push(name);
        saveData();
        openCompanionsModal();
    };

    window.deleteCompanion = function(index) {
        if(confirm(`ç¢ºå®šåˆªé™¤ ${appData.companions[index]}ï¼Ÿ`)) {
            appData.companions.splice(index, 1);
            saveData();
            openCompanionsModal();
        }
    };

    window.editCompanion = function(index) {
        const newName = prompt("ä¿®æ”¹åå­—:", appData.companions[index]);
        if(newName && newName.trim()) {
            appData.companions[index] = newName.trim();
            saveData();
            openCompanionsModal();
        }
    };

    function clearExpenses() { if(confirm("æ¸…é™¤æ‰€æœ‰è¨˜å¸³ç´€éŒ„ï¼Ÿ")) { appData.expenses=[]; saveData(); renderExpenses(); } }
    
    function renderExpenses() {
        let total = 0; let myShare = 0;
        $('expense-list').innerHTML = appData.expenses.map((e,i) => {
            const r = appData.rates[e.currency] || 1;
            const twdAmt = Math.round(e.amount * r);
            total += twdAmt;
            
            // Calculate My Share
            if(e.splitWith && e.splitWith.includes('æˆ‘')) {
                myShare += Math.round(twdAmt / e.splitWith.length);
            }
            
            const cat = EXP_CATS[e.category] || EXP_CATS['other'];
            const splitText = e.splitWith && e.splitWith.length > 1 ? `(${e.splitWith.join(', ')})` : '';
            
            return `<div class="expense-item" onclick="openAddExpenseModal(${i})"><div class="expense-icon">${e.photo ? `<img src="${e.photo}" style="width:100%; height:100%; border-radius:12px; object-fit:cover;">` : cat.icon}</div><div style="flex:1;"><div style="font-weight:bold; font-size:15px;">${e.item}</div><div style="font-size:12px; color:var(--text-sub);">${e.payer} ä»˜æ¬¾ ${splitText}</div></div><div style="text-align:right;"><div style="font-weight:bold;">${e.amount} ${e.currency}</div><div style="font-size:12px; color:var(--text-sub);">â‰ˆ ${twdAmt} TWD</div></div></div>`;
        }).join('') || `<div style="text-align:center; padding:20px; color:#ccc;">å°šç„¡æ¶ˆè²»ç´€éŒ„</div>`;
        $('total-grand-twd').innerText = total.toLocaleString();
        $('my-share-display').innerText = `æˆ‘æ‡‰ä»˜: NT$ ${myShare.toLocaleString()}`;
        const sums = {}; appData.expenses.forEach(e => { sums[e.currency] = (sums[e.currency]||0) + e.amount; });
        $('currency-totals').innerHTML = Object.keys(sums).map(c => `<div>${sums[c].toFixed(1)} ${c}</div>`).join('');
    }
    
    function openAddExpenseModal(idx=-1, def={}) {
        const isEdit = idx >= 0;
        const d = isEdit ? appData.expenses[idx] : { item:'', amount: def.amount||'', currency: def.currency||appData.activeCurrencies[0], payer:'æˆ‘', splitWith:['æˆ‘'], category:'food', photo:'' };
        
        // Generate Companion Checkboxes
        let companionCheckboxes = `<div class="form-group"><label class="form-label">åˆ†å¸³å°è±¡ (å‹¾é¸åƒèˆ‡è€…)</label><div class="checkbox-group">`;
        appData.companions.forEach(comp => {
            const isChecked = d.splitWith && d.splitWith.includes(comp) ? 'checked' : '';
            companionCheckboxes += `<label class="checkbox-item"><input type="checkbox" name="split-comp" value="${comp}" ${isChecked}> ${comp}</label>`;
        });
        companionCheckboxes += `</div></div>`;

        const html = `
            <div class="form-group"><label class="form-label">é …ç›®</label><input id="ex-item" value="${d.item}" class="form-input"></div>
            <div style="display:flex; gap:10px;"><div style="flex:1"><label class="form-label">é‡‘é¡</label><input id="ex-amt" type="number" value="${d.amount}" class="form-input"></div><div style="width:80px"><label class="form-label">å¹£åˆ¥</label><select id="ex-curr" class="form-select">${appData.activeCurrencies.map(c=>`<option ${c===d.currency?'selected':''}>${c}</option>`).join('')}</select></div></div>
            <div class="form-group"><label class="form-label">åˆ†é¡</label><select id="ex-cat" class="form-select">${Object.keys(EXP_CATS).map(k=>`<option value="${k}" ${k===d.category?'selected':''}>${EXP_CATS[k].name}</option>`).join('')}</select></div>
            <div class="form-group"><label class="form-label">ä»˜æ¬¾äºº</label><select id="ex-payer" class="form-select">${appData.companions.map(c=>`<option ${c===d.payer?'selected':''}>${c}</option>`).join('')}</select></div>
            ${companionCheckboxes}
            <div style="text-align:right;"><button onclick="if(confirm('åˆªé™¤?')){appData.expenses.splice(${idx},1);saveData();renderExpenses();closeModal();}" style="color:red;border:none;background:none;display:${isEdit?'inline-block':'none'}">åˆªé™¤</button></div>
        `;
        openModal(isEdit?"ç·¨è¼¯æ”¯å‡º":"è¨˜å¸³", html, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="saveExpense(${idx})" class="btn-modal-save">å„²å­˜</button>`);
    }
    
    function saveExpense(idx) {
        // Collect checked split companions
        const splitWith = Array.from(document.querySelectorAll('input[name="split-comp"]:checked')).map(cb => cb.value);
        if(splitWith.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€ä½åˆ†å¸³å°è±¡"); return; }

        const val = {
            item: $('ex-item').value, amount: parseFloat($('ex-amt').value)||0, currency: $('ex-curr').value,
            category: $('ex-cat').value, payer: $('ex-payer').value, splitWith: splitWith,
            photo: idx>=0 ? appData.expenses[idx].photo : ''
        };
        if(idx>=0) appData.expenses[idx] = val; else appData.expenses.push(val);
        saveData(); renderExpenses(); closeModal();
    }

    /* --- GUIDE --- */
    function renderGuideView() {
        const tabs = GUIDE_TABS.map(t=>`<div class="day-tab-item ${activeGuideTab===t.id?'active':''}" onclick="activeGuideTab='${t.id}';renderGuideView()"><div class="day-tab-num">${t.icon}</div><div class="day-tab-label">${t.name}</div></div>`).join('');
        $('guide-tab-bar').innerHTML = tabs;
        const list = activeGuideTab==='guides' ? appData.guides : (activeGuideTab==='memos'?appData.memos:(activeGuideTab==='emergency'?appData.emergency:appData.notes));
        const btnTxt = GUIDE_TABS.find(t=>t.id===activeGuideTab).name;
        $('btn-guide-add').innerText = "+ æ–°å¢" + btnTxt;
        $('guide-content-area').innerHTML = list.map((item,i)=>`<div class="list-item-card" style="display:block;"><div style="display:flex;justify-content:space-between;"><b>${item.title||''}</b><button onclick="deleteGuideItem('${activeGuideTab}',${i})">âœ•</button></div><div style="white-space:pre-wrap;opacity:0.8;font-size:14px;">${item.content||item.text}</div>${item.mapQuery?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.mapQuery)}" target="_blank" class="btn-action" style="margin-top:5px">ğŸ“</a>`:''}</div>`).join('') || '<div style="text-align:center;padding:20px;opacity:0.5">å°šç„¡å…§å®¹</div>';
    }
    function handleAddInGuide() { if(activeGuideTab==='guides') openModal("æ–°å¢å°è¦½", `<input id="gt" class="form-input" placeholder="æ¨™é¡Œ"><textarea id="gc" class="form-textarea" placeholder="å…§å®¹"></textarea><input id="gm" class="form-input" placeholder="åœ°åœ–">`, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="appData.guides.push({title:$('gt').value,content:$('gc').value,mapQuery:$('gm').value});saveData();renderGuideView();closeModal()" class="btn-modal-save">å„²å­˜</button>`); else addListItem(activeGuideTab); }
    function deleteGuideItem(type, i) { if(confirm("åˆªé™¤?")) { appData[type].splice(i,1); saveData(); renderGuideView(); } }
    function addListItem(type) { const isMemo = type==='memos'; openModal("æ–°å¢", isMemo?`<input id="li-t" class="form-input" placeholder="å…§å®¹">`:`<input id="li-ti" class="form-input" placeholder="æ¨™é¡Œ"><textarea id="li-co" class="form-textarea" placeholder="å…§å®¹"></textarea>`, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="const v=${isMemo}?{text:$('li-t').value}:{title:$('li-ti').value,content:$('li-co').value}; appData['${type}'].push(v); saveData(); ${type==='checklist'?'renderItinerary()':'renderGuideView()'}; closeModal()" class="btn-modal-save">å„²å­˜</button>`); }

    /* --- OTHERS --- */
    function renderTickets() { $('tickets-list').innerHTML = appData.tickets.map((t,i)=>`<div class="card" style="margin:0;padding:0;overflow:hidden;background:var(--secondary);" onclick="openTicketModal(${i})"><div style="height:120px;background:#eee;display:flex;align-items:center;justify-content:center;">${t.photo?`<img src="${t.photo}" style="width:100%;height:100%;object-fit:cover">`:'ğŸ«'}</div><div style="padding:10px"><b>${t.title}</b><div style="font-size:12px">${t.date}</div></div></div>`).join(''); }
    function openTicketModal(i=-1) { const d=i>=0?appData.tickets[i]:{title:'',date:'',note:'',photo:''}; openModal("ç¥¨åˆ¸", `<div class="form-group"><input id="tt" value="${d.title}" class="form-input" placeholder="åç¨±"></div><div class="form-group"><input id="td" value="${d.date}" class="form-input" placeholder="æ—¥æœŸ"></div><div class="form-group"><input id="tn" value="${d.note}" class="form-input" placeholder="å‚™è¨»"></div><input type="file" id="tf" style="display:none" onchange="compressImage(this,null,null,b=>{appData.tickets[${i>=0?i:appData.tickets.length}].photo=b;saveData();renderTickets();closeModal()})"><button onclick="$('tf').click()" class="btn-add-block">ä¸Šå‚³åœ–ç‰‡</button><div style="text-align:right; margin-top:10px;"><button onclick="if(confirm('åˆªé™¤?')){appData.tickets.splice(${i},1);saveData();renderTickets();closeModal();}" style="color:red;border:none;background:none;display:${i>=0?'inline-block':'none'}">åˆªé™¤</button></div>`, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="const v={title:$('tt').value,date:$('td').value,note:$('tn').value,photo:appData.tickets[${i}]?.photo||''}; if(${i}>=0) appData.tickets[${i}]=v; else appData.tickets.push(v); saveData(); renderTickets(); closeModal()" class="btn-modal-save">å„²å­˜</button>`); }
    function compressImage(input, p1, p2, callback) { if(input.files[0]) { const r = new FileReader(); r.onload = e => { const img = new Image(); img.onload = () => { const c = document.createElement('canvas'); const mw = 800; let w = img.width, h = img.height; if(w>mw) { h*=mw/w; w=mw; } c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); callback(c.toDataURL('image/jpeg', 0.6)); }; img.src = e.target.result; }; r.readAsDataURL(input.files[0]); } }

    /* --- BACKUP & EXPORT --- */
    window.arrayToCSV = function(arr) { if (!arr || !arr.length) return ""; const keys = Object.keys(arr[0]); const header = keys.join(","); const rows = arr.map(obj => { return keys.map(k => { let val = obj[k] === null || obj[k] === undefined ? "" : String(obj[k]); val = val.replace(/"/g, '""'); if (val.includes(",") || val.includes("\n") || val.includes('"')) { val = `"${val}"`; } return val; }).join(","); }).join("\n"); return header + "\n" + rows; }
    window.csvToArray = function(str, delimiter = ",") { const headers = str.slice(0, str.indexOf("\n")).split(delimiter).map(h => h.trim()); const rows = str.slice(str.indexOf("\n") + 1).split("\n"); const arr = []; rows.forEach(row => { if(!row.trim()) return; const values = []; let inQuote = false; let val = ""; for(let i=0; i<row.length; i++) { const char = row[i]; if(char === '"' && row[i+1] === '"') { val += '"'; i++; } else if(char === '"') { inQuote = !inQuote; } else if(char === delimiter && !inQuote) { values.push(val); val = ""; } else { val += char; } } values.push(val); const obj = {}; headers.forEach((h, i) => obj[h] = values[i]); arr.push(obj); }); return arr; }
    
    window.exportAllCSV = function() { 
        const data = []; 
        if(appData.booking.flights) data.push({ DataType: 'flight', Detail: appData.booking.flights }); 
        appData.booking.hotels.forEach(h => data.push({ DataType: 'hotel', Subject: h.name, Detail: h.desc, Location: h.mapQuery })); 
        
        // Itinerary + Events + Transport
        appData.itinerary.forEach(day => { 
            // Events
            day.events.forEach(ev => data.push({ DataType: 'itinerary', Date: day.date, Status: day.weather, Time: ev.time, Subject: ev.title, Detail: ev.desc, Location: ev.mapQuery, Metadata: ev.weatherQuery })); 
            // Daily Transport
            if (day.transport) {
                day.transport.forEach(t => data.push({ DataType: 'daily_transport', Date: day.date, Time: `${t.depTime}-${t.arrTime}`, Subject: t.type, From: t.from, To: t.to, Detail: 'Daily Transport' }));
            }
        }); 
        
        // Root Transport (Separate Tab)
        if (appData.transport) {
             appData.transport.forEach(t => data.push({ DataType: 'transport', Date: t.date, Subject: t.type, From: t.from, To: t.to, Detail: t.note, Location: t.link })); 
        }
        
        appData.tickets.forEach(t => data.push({ DataType: 'ticket', Date: t.date, Subject: t.title, Detail: t.note })); 
        appData.expenses.forEach(e => data.push({ DataType: 'expense', Subject: e.item, Amount: e.amount, Currency: e.currency, Category: e.category, Payer: e.payer, Metadata: e.splitWith ? e.splitWith.join('|') : '' })); 
        appData.shoppingList.forEach(s => data.push({ DataType: 'shop', Subject: s.item, Amount: s.price, Currency: s.currency, Detail: s.desc, Status: s.isBought ? 'Bought' : 'Pending' }));
        appData.guides.forEach(g => data.push({ DataType: 'guide', Subject: g.title, Detail: g.content, Location: g.mapQuery }));
        
        // Helper lists
        const listTypes = ['checklist', 'memos', 'emergency', 'notes'];
        listTypes.forEach(type => {
            if(appData[type]) {
                appData[type].forEach(item => data.push({ DataType: type, Subject: item.title || item.text, Detail: item.content || '', Status: item.checked ? 'Checked' : '' }));
            }
        });

        if(data.length === 0) { alert("ç„¡è³‡æ–™å¯åŒ¯å‡º"); return; } 
        
        const allKeys = ['DataType', 'Date', 'Time', 'Subject', 'Detail', 'Location', 'From', 'To', 'Amount', 'Currency', 'Category', 'Payer', 'Status', 'Metadata']; 
        const formattedData = data.map(item => { const row = {}; allKeys.forEach(k => row[k] = item[k] || ''); return row; }); 
        const csvContent = "\uFEFF" + arrayToCSV(formattedData); 
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); 
        const link = document.createElement("a"); 
        link.href = URL.createObjectURL(blob); 
        link.download = "Travel_Data.csv"; 
        link.click(); 
    }

    window.openImportCSVModal = function() { 
        const html = `<textarea id="import-csv-text" class="form-textarea" style="height:200px;" placeholder="è«‹è²¼ä¸Š CSV å…§å®¹... (æ³¨æ„: æ­¤æ“ä½œæœƒè¦†è“‹ç¾æœ‰è³‡æ–™)"></textarea>`; 
        openModal("åŒ¯å…¥ CSV", html, `<button onclick="closeModal()" class="btn-modal-cancel">å–æ¶ˆ</button><button onclick="processCSVImport()" class="btn-modal-save">åŒ¯å…¥</button>`); 
    }

    window.processCSVImport = function() { 
        const text = document.getElementById('import-csv-text').value; 
        if(!text.trim()) return; 
        
        try { 
            const rawData = csvToArray(text); 
            // Re-initialize appData structures to empty
            const newBooking = { flights: "", hotels: [] }; 
            const newItinerary = []; 
            const newExpenses = []; 
            const newShopping = [];
            const newTickets = [];
            const newTransport = []; // Root transport
            const newGuides = [];
            const newLists = { checklist:[], memos:[], emergency:[], notes:[] };

            // Helper to find or create day
            const getDay = (dateStr, weatherStr) => {
                let day = newItinerary.find(d => d.date === dateStr);
                if (!day) {
                    day = { date: dateStr, weather: weatherStr || "", events: [], transport: [] };
                    newItinerary.push(day);
                }
                return day;
            };

            rawData.forEach(row => { 
                const type = (row.DataType || "").toLowerCase(); 
                
                if (type === 'flight') newBooking.flights = row.Detail || ""; 
                else if (type === 'hotel') newBooking.hotels.push({ name: row.Subject, desc: row.Detail, mapQuery: row.Location }); 
                else if (type === 'itinerary') { 
                    if (row.Date) { 
                        const day = getDay(row.Date, row.Status);
                        if (row.Subject) day.events.push({ time: row.Time, title: row.Subject, desc: row.Detail, mapQuery: row.Location, weatherQuery: row.Metadata }); 
                    } 
                } 
                else if (type === 'daily_transport') {
                    if (row.Date) {
                        const day = getDay(row.Date, "");
                        const [dep, arr] = (row.Time || "-").split('-');
                        day.transport.push({ depTime: dep, arrTime: arr, type: row.Subject, from: row.From, to: row.To });
                    }
                }
                else if (type === 'transport') {
                    // Root transport tab items
                    newTransport.push({ date: row.Date, type: row.Subject, from: row.From, to: row.To, note: row.Detail, link: row.Location });
                }
                else if (type === 'ticket') newTickets.push({ date: row.Date, title: row.Subject, note: row.Detail });
                else if (type === 'expense') newExpenses.push({ id: Date.now() + Math.random(), item: row.Subject, amount: parseFloat(row.Amount)||0, currency: row.Currency, category: row.Category, payer: row.Payer, splitWith: row.Metadata ? row.Metadata.split('|') : [] }); 
                else if (type === 'shop') newShopping.push({ id: Date.now() + Math.random(), item: row.Subject, price: parseFloat(row.Amount)||0, currency: row.Currency, desc: row.Detail, isBought: row.Status === 'Bought' });
                else if (type === 'guide') newGuides.push({ title: row.Subject, content: row.Detail, mapQuery: row.Location });
                else if (newLists[type]) {
                    newLists[type].push({ title: row.Subject, text: row.Subject, content: row.Detail, checked: row.Status === 'Checked' });
                }
            }); 
            
            // Assign back
            appData.booking = newBooking; 
            appData.itinerary = newItinerary; 
            appData.expenses = newExpenses; 
            appData.shoppingList = newShopping;
            appData.tickets = newTickets;
            // appData.transport = newTransport; // If you use root transport
            appData.guides = newGuides;
            appData.checklist = newLists.checklist;
            appData.memos = newLists.memos;
            appData.emergency = newLists.emergency;
            appData.notes = newLists.notes;

            saveData(); 
            refreshAllUI(); 
            closeModal(); 
            alert("åŒ¯å…¥æˆåŠŸï¼"); 
        } catch(e) { 
            console.error(e);
            alert("è§£æå¤±æ•—: " + e.message); 
        } 
    }

    function downloadBackup() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "trip_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }
    function restoreBackup(input) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const obj = JSON.parse(e.target.result);
                if(obj.title) { appData = obj; saveData(); refreshAllUI(); alert("é‚„åŸæˆåŠŸï¼"); }
            } catch(err) { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); }
        };
        reader.readAsText(input.files[0]);
    }
    function openImportCSVModal() { alert("åŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹å…ˆä½¿ç”¨ JSON å‚™ä»½åŠŸèƒ½ã€‚"); }
    function copyItineraryText() {
        let text = `${appData.title}\n${appData.dates}\n\n`;
        appData.itinerary.forEach(d => {
            text += `ã€${d.date}ã€‘ ${d.weather||''}\n`;
            d.events.forEach(e => text += `${e.time} ${e.title}\n`);
            text += '\n';
        });
        navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½è¡Œç¨‹åˆ°å‰ªè²¼ç°¿ï¼"));
    }
    
    /* --- ADDED MISSING FUNCTION --- */
    function fetchHomeWeather() {
        const container = $('weekly-weather-container');
        const locName = $('weather-loc-name');
        
        // This function MUST exist to prevent ReferenceError
        if (!container || !locName) return;

        let location = "æœªæŒ‡å®šåœ°é»";
        if (appData.itinerary.length > 0 && appData.itinerary[0].events.length > 0) {
            location = appData.itinerary[0].events[0].mapQuery || appData.itinerary[0].events[0].title;
        } else if (appData.booking.hotels.length > 0) {
            location = appData.booking.hotels[0].name;
        }

        if (location === "æœªæŒ‡å®šåœ°é»") {
             container.innerHTML = '<div style="width:100%; text-align:center; padding:15px; opacity:0.6;">è«‹å…ˆåœ¨ã€Œè¡Œç¨‹ã€ä¸­æ–°å¢åœ°é»ä»¥é¡¯ç¤ºå¤©æ°£</div>';
             locName.innerText = location;
             return;
        }

        locName.innerText = location;
        
        // Mock data generation (since real API needs keys/proxy)
        const weathers = ['â˜€ï¸', 'â˜ï¸', 'ğŸŒ§ï¸', 'â›…', 'â›ˆï¸'];
        let html = '';
        for(let i=0; i<5; i++) {
            const date = new Date();
            date.setDate(date.getDate() + i);
            const dayStr = (date.getMonth()+1) + '/' + date.getDate();
            const w = weathers[Math.floor(Math.random() * weathers.length)];
            const temp = 20 + Math.floor(Math.random() * 10);
            
            html += `<div class="weather-day">
                <div style="font-size:12px; margin-bottom:4px;">${dayStr}</div>
                <div class="weather-icon">${w}</div>
                <div style="font-size:14px; font-weight:bold;">${temp}Â°</div>
            </div>`;
        }
        container.innerHTML = html;
    }

    // INIT
    initApp();
</script>
</body>
</html>
