<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—…éŠæ‰‹å¸³ App (v3.6 Safe Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Zen+Maru+Gothic:wght@500;700&family=Shippori+Mincho:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-color: #e8e4e1;
            --paper-color: #f9f7f2;
            --primary: #ffb7c5;
            --secondary: #fff0f5;
            --header-grad-1: #fff;
            --header-grad-2: #fff0f5;
            --accent: #a8c2a3;
            --text-main: #5e524b;
            --text-light: #8a8077;
            --radius: 16px;
            --shadow: 0 4px 12px rgba(94, 82, 75, 0.08);
            --danger: #ff6b6b;
        }

        [data-theme="matcha"] { --bg-color: #e1e8e1; --paper-color: #f4f9f4; --primary: #88a886; --secondary: #e6f0e6; --header-grad-1: #fff; --header-grad-2: #e6f0e6; --accent: #d4a373; --text-main: #4b5e4b; }
        [data-theme="ocean"] { --bg-color: #e1e6e8; --paper-color: #f0f8ff; --primary: #89c2d9; --secondary: #e0f7fa; --header-grad-1: #fff; --header-grad-2: #e0f7fa; --accent: #ffb7b2; --text-main: #3e505b; }
        [data-theme="dark"] { --bg-color: #1a1a1a; --paper-color: #2d2d2d; --primary: #bb86fc; --secondary: #333; --header-grad-1: #2d2d2d; --header-grad-2: #2d2d2d; --accent: #03dac6; --text-main: #e0e0e0; --text-light: #aaa; --shadow: 0 4px 12px rgba(0,0,0,0.5); --danger: #ff4444; }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-color); font-family: 'Zen Maru Gothic', 'Noto Sans TC', sans-serif; margin: 0; color: var(--text-main); display: flex; justify-content: center; min-height: 100vh; transition: background 0.3s; }
        .app-container { width: 100%; max-width: 480px; background-color: var(--paper-color); min-height: 100vh; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); padding-bottom: 90px; transition: background 0.3s; }

        /* Header */
        header { background: linear-gradient(135deg, var(--header-grad-1) 0%, var(--header-grad-2) 100%); padding: 20px 20px 10px; border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; box-shadow: var(--shadow); position: sticky; top: 0; z-index: 90; }
        .header-top-row { display: flex; align-items: center; gap: 10px; }
        .btn-trip-mgr { background: rgba(0,0,0,0.05); border: none; font-size: 18px; padding: 5px 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn-trip-mgr:hover { background: rgba(0,0,0,0.1); }
        .header-editable { cursor: pointer; border-bottom: 1px dashed transparent; transition: 0.2s; display: inline-block; }
        .header-editable:hover { border-bottom-color: var(--text-light); opacity: 0.7; }
        h1 { margin: 0; font-size: 20px; color: var(--text-main); display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .subtitle { font-size: 13px; color: var(--text-light); margin-top: 6px; padding-left: 45px; }

        /* Navigation */
        .nav-tabs { display: flex; flex-wrap: wrap; padding: 10px 5px; gap: 8px; justify-content: flex-start; }
        .tab { padding: 8px 12px; border-radius: 20px; font-size: 13px; font-weight: bold; cursor: pointer; transition: 0.3s; background: rgba(255,255,255,0.6); white-space: nowrap; border: 1px solid rgba(0,0,0,0.05); color: var(--text-main); flex: 1 0 auto; text-align: center; min-width: 50px; }
        [data-theme="dark"] .tab { background: rgba(255,255,255,0.1); }
        .tab.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        /* Views */
        .content-view { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .content-view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Elements */
        .btn-edit { background: none; border: none; font-size: 16px; cursor: pointer; opacity: 0.6; padding: 5px; }
        .btn-delete-icon { background: none; border: none; font-size: 18px; cursor: pointer; opacity: 0.8; color: var(--danger); padding: 8px; display: flex; align-items: center; justify-content: center; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal { background: white; width: 85%; max-width: 350px; padding: 20px; border-radius: 16px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        [data-theme="dark"] .modal { background: #333; color: white; }
        .modal h3 { margin-top: 0; color: var(--text-main); }
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 4px; color: var(--text-light); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        [data-theme="dark"] .form-input, [data-theme="dark"] .form-textarea, [data-theme="dark"] .form-select { background: #444; border-color: #555; color: white; }
        .form-textarea { resize: vertical; min-height: 80px; }
        
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #eee; color: #666; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; }
        [data-theme="dark"] .btn-cancel { background: #555; color: #ccc; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn-danger:hover { opacity: 0.9; }
        .btn-secondary { background: var(--secondary); color: var(--text-main); border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }

        /* Cards & Lists */
        .card { background: #fff; border-radius: var(--radius); margin-bottom: 24px; box-shadow: var(--shadow); overflow: hidden; position: relative; padding: 16px; }
        [data-theme="dark"] .card { background: #333; }
        
        .day-card { background: #fff; border-radius: var(--radius); margin-bottom: 24px; box-shadow: var(--shadow); overflow: hidden; position: relative; }
        [data-theme="dark"] .day-card { background: #333; }
        .day-header { background: var(--accent); color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .timeline { padding: 16px; }
        
        .wallet-card { background: linear-gradient(135deg, #5e524b 0%, #4a403a 100%); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; box-shadow: var(--shadow); }
        
        /* Items */
        .list-item { border-bottom: 1px dashed #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: flex-start; }
        .list-item:last-child { border-bottom: none; }
        .expense-item { background: #f9f9f9; padding: 10px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; gap: 10px; cursor: pointer; }
        [data-theme="dark"] .expense-item { background: #444; }

        /* Buttons & Actions */
        .btn-action { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 11px; text-decoration: none; font-weight: bold; transition: 0.2s; margin-top: 5px; }
        .btn-map { background: #e3f2fd; color: #1e88e5; }
        .btn-link { background: #fce4ec; color: #d81b60; }
        .btn-add-block { width: 100%; padding: 12px; border: 2px dashed #ccc; background: none; border-radius: 12px; color: var(--text-light); cursor: pointer; font-weight: bold; text-align: center; }
        
        /* Weather Styles */
        .weather-scroll-container { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; }
        .weather-day-item { flex: 0 0 auto; min-width: 105px; text-align: center; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 12px; border: 1px solid rgba(0,0,0,0.05); }
        .weather-day-item div { margin-bottom: 3px; }
        .weather-icon-lg { font-size: 28px; margin: 5px 0; }
        .clothing-advice { font-size: 11px; color: var(--text-light); background: rgba(255,255,255,0.5); padding: 2px 5px; border-radius: 8px; display: inline-block; margin-top: 4px; }
        [data-theme="dark"] .weather-day-item { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); }
        [data-theme="dark"] .clothing-advice { background: rgba(0,0,0,0.3); color: #ccc; }
        
        /* Checkbox & Tags */
        .tag-group { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; }
        .tag.payer { background: #e3f2fd; color: #1565c0; }
        .checkbox-wrapper { display: flex; align-items: center; gap: 10px; width: 100%; }
        .checkbox-wrapper input[type="checkbox"] { width: 18px; height: 18px; }
        
        /* Edit Elements */
        .event-edit-row { background:#f9f9f9; padding:10px; border-radius:8px; margin-bottom:10px; border:1px solid #eee; position: relative; }
        .btn-remove-event { position: absolute; top: 5px; right: 5px; color: var(--danger); background: none; border: none; font-size: 16px; cursor: pointer; }
        [data-theme="dark"] .event-edit-row { background: #444; border-color: #555; }

        /* Theme Grid */
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .theme-btn { padding: 15px; border-radius: 12px; border: 2px solid transparent; cursor: pointer; font-weight: bold; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .theme-btn.active { border-color: var(--text-main); transform: scale(0.98); }

        /* Calculator & Wallet */
        .calculator-area { background: var(--secondary); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); }
        .calc-display { font-family: monospace; font-size: 24px; text-align: right; margin-top: 5px; color: var(--text-main); font-weight: bold; }
        .calc-sub { font-size: 13px; text-align: right; color: var(--text-light); height: 20px; }
        .expense-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; flex-shrink: 0; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; }
        
        /* Transport & Tickets */
        .transport-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: var(--shadow); position: relative; border-left: 5px solid var(--primary); }
        [data-theme="dark"] .transport-card { background: #333; }
        .ticket-card { background: #fff; border-radius: 12px; overflow: hidden; margin-bottom: 15px; box-shadow: var(--shadow); position: relative; }
        [data-theme="dark"] .ticket-card { background: #333; }
        .ticket-img { width: 100%; height: 160px; object-fit: cover; display: block; background: #eee; cursor: pointer; }
        .ticket-info { padding: 12px; }
        .ticket-actions { display: flex; justify-content: flex-end; padding: 0 10px 10px; gap: 10px; }

        /* Trip Manager List */
        .trip-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: #f9f9f9; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; cursor: pointer; }
        .trip-item:hover { background: #f0f0f0; }
        .trip-item.active-trip { border: 2px solid var(--primary); background: var(--secondary); }
        
        /* Image Preview Modal */
        #img-modal { background: rgba(0,0,0,0.9); }
        #img-modal img { max-width: 100%; max-height: 80vh; border-radius: 4px; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="header-top-row">
            <button class="btn-trip-mgr" onclick="openTripManager()" title="æˆ‘çš„æ‰‹å¸³åˆ—è¡¨">ğŸ“š</button>
            <h1><span id="app-title" class="header-editable" onclick="editHeader()">æ—…éŠæ‰‹å¸³</span></h1>
        </div>
        <div class="subtitle"><span id="app-dates" class="header-editable" onclick="editHeader()">æ—¥æœŸ | èˆªç­è³‡è¨Š</span></div>
        <div class="nav-tabs">
            <!-- Ensure Booking is first and default -->
            <div class="tab active" onclick="switchTab('booking')">é¦–é  / é è¨‚</div>
            <div class="tab" onclick="switchTab('itinerary')">è¡Œç¨‹</div>
            <div class="tab" onclick="switchTab('transport')">äº¤é€š</div>
            <div class="tab" onclick="switchTab('tickets')">ç¥¨åˆ¸</div>
            <div class="tab" onclick="switchTab('wallet')">éŒ¢åŒ…</div>
            <div class="tab" onclick="switchTab('guide')">å°è¦½</div>
            <div class="tab" onclick="switchTab('lists')">æ¸…å–®</div>
            <div class="tab" onclick="switchTab('info')">è³‡è¨Š</div>
            <div class="tab" onclick="switchTab('settings')">è¨­å®š</div>
        </div>
    </header>

    <!-- VIEWS -->
    <div id="booking-view" class="content-view active">
        <!-- New Weather Card -->
        <div class="card" id="home-weather-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3>ğŸŒ¤ï¸ ç•¶åœ°å¤©æ°£</h3>
                <div style="font-size:12px; color:var(--text-light);"><span id="weather-loc-name">è¼‰å…¥ä¸­...</span></div>
            </div>
            <div id="weekly-weather-container" class="weather-scroll-container">
                <div style="width:100%; text-align:center; padding:10px; color:#aaa;">è«‹å…ˆè¨­å®šè¡Œç¨‹ç¬¬ä¸€å¤©åœ°é»ä»¥é¡¯ç¤ºå¤©æ°£</div>
            </div>
            <!-- Legend -->
            <div style="text-align:right; font-size:10px; color:var(--text-light); margin-top:5px;">
                * é«”æ„Ÿæº«åº¦ç‚ºä¼°ç®—å€¼ï¼Œç©¿è¡£è«‹ä¾å€‹äººé«”è³ªèª¿æ•´
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between;"><h3>âœˆï¸ èˆªç­è³‡è¨Š</h3><button onclick="editBookingText('flights')" class="btn-edit">âœï¸</button></div>
            <div id="booking-flights" style="white-space: pre-wrap; font-size:14px; line-height:1.6;"></div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                <h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            </div>
            <div id="booking-hotels-container"></div>
            <button onclick="openHotelModal()" class="btn-add-block" style="margin-top:10px;">+ æ–°å¢ä½å®¿</button>
        </div>
    </div>

    <div id="itinerary-view" class="content-view">
        <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
            <button onclick="copyItineraryText()" class="btn-secondary" style="font-size:12px; padding:6px 12px;">ğŸ“‹ è¤‡è£½è¡Œç¨‹æ–‡å­—</button>
        </div>
        <div id="itinerary-container"></div>
        <button onclick="addDay()" class="btn-add-block">+ æ–°å¢ä¸€å¤©</button>
        <div style="text-align:center; padding:10px; opacity:0.6; font-size:12px;">é»æ“Šæ—¥æœŸå³å´ âœï¸ å¯ä¿®æ”¹è¡Œç¨‹èˆ‡å¤©æ°£</div>
    </div>

    <div id="transport-view" class="content-view">
        <div id="transport-list"></div>
        <button onclick="openTransportModal()" class="btn-add-block" style="background:var(--secondary); border:none; color:var(--text-main);">+ æ–°å¢äº¤é€šè³‡è¨Š</button>
    </div>

    <div id="tickets-view" class="content-view">
        <div id="tickets-list"></div>
        <button onclick="openTicketModal()" class="btn-add-block" style="background:var(--secondary); border:none; color:var(--text-main);">+ æ–°å¢ç¥¨åˆ¸/æ†‘è­‰</button>
    </div>

    <div id="guide-view" class="content-view">
        <div id="guide-container"></div>
        <button onclick="addNewGuide()" class="btn-add-block">+ æ–°å¢å°è¦½æ–‡ç« </button>
    </div>

    <!-- WALLET VIEW -->
    <div id="wallet-view" class="content-view">
        <div class="calculator-area">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span style="font-size:12px; opacity:0.8;">ğŸ§® åŒ¯ç‡æ›ç®— & è¨ˆç®—æ©Ÿ</span>
                <div style="display:flex; gap:5px;">
                    <select id="calc-currency" onchange="updateCalc()" style="background:white; border:none; border-radius:4px; padding:2px; font-size:12px;">
                        <!-- Options populated by JS -->
                    </select>
                    <button onclick="openCurrencyManager()" style="font-size:10px; padding:2px 6px; border:1px solid #999; border-radius:4px; background:none;">âš™ï¸</button>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                <span style="font-size:12px; opacity:0.8;">åŒ¯ç‡:</span>
                <input id="calc-rate" type="number" step="0.0001" style="width:60px; padding:2px; font-size:12px; border:1px solid #ccc; border-radius:4px;" onchange="manualRateUpdate()">
            </div>
            <input id="calc-input" type="text" placeholder="è¼¸å…¥ç®—å¼ (ä¾‹: 500+200*3)" class="form-input" style="text-align:right; font-size:18px;" onkeyup="updateCalc()">
            <div class="calc-sub" id="calc-result-raw">0</div>
            <div class="calc-display">â‰ˆ NT$ <span id="calc-result-twd">0</span></div>
            <button onclick="addExpenseFromCalc()" class="btn-save" style="width:100%; margin-top:10px;">ğŸ‘‡ å°‡æ­¤é‡‘é¡è¨˜å¸³</button>
        </div>
        <div style="text-align:right; margin-bottom:10px;">
            <button onclick="openCompanionsModal()" style="font-size:12px; padding:4px 8px; border:1px solid #ccc; background:white; border-radius:12px;">ğŸ‘¥ ç®¡ç†æ—…ä¼´</button>
        </div>
        <div class="wallet-card">
            <div style="font-size:12px; opacity:0.8; margin-bottom:5px;">å„å¹£åˆ¥ç¸½è¨ˆ</div>
            <div id="currency-totals" style="font-size:14px; font-family:monospace; line-height:1.5;"></div>
            <div style="text-align:right; margin-top:10px;">
                <div style="font-size:12px; opacity:0.7;">ç¸½æ”¯å‡º (ä¼°ç®— TWD)</div>
                <div id="total-grand-twd" style="font-size:28px; font-weight:bold; font-family:monospace;">0</div>
                <div id="my-share-display" style="font-size:12px; color:#ffb7c5; margin-top:4px;">å€‹äººæ‡‰ä»˜: 0</div>
            </div>
        </div>
        <button onclick="openAddExpenseModal()" class="btn-add-block" style="margin-bottom:20px; background:var(--primary); color:white; border:none;">+ æ–°å¢æ¶ˆè²» (æ‰‹å‹•)</button>
        <div id="expense-list"></div>
        <button onclick="clearExpenses()" style="width:100%; margin-top:20px; padding:10px; border:none; background:none; color:#999;">æ¸…é™¤ç´€éŒ„</button>
    </div>

    <div id="lists-view" class="content-view">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h4>ğŸ“‹ è¡Œå‰æ¸…å–®</h4>
                <button onclick="addListItem('checklist')" class="btn-edit">â•</button>
            </div>
            <div id="checklist-container"></div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h4>ğŸ“ å‚™å¿˜éŒ„</h4>
                <button onclick="addListItem('memos')" class="btn-edit">â•</button>
            </div>
            <div id="memos-container"></div>
        </div>
    </div>

    <div id="info-view" class="content-view">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>ğŸš¨ ç·Šæ€¥è¯çµ¡</h3>
                <button onclick="addListItem('emergency')" class="btn-edit">â•</button>
            </div>
            <div id="info-emergency-container"></div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <h3>âš ï¸ æ—…éŠç­†è¨˜</h3>
                <button onclick="addListItem('notes')" class="btn-edit">â•</button>
            </div>
            <div id="info-notes-container"></div>
        </div>
    </div>

    <div id="settings-view" class="content-view">
        <div class="card">
            <h3>ğŸ¨ é¢¨æ ¼ä¸»é¡Œ</h3>
            <div class="theme-grid">
                <div class="theme-btn" style="background:#fff0f5; color:#5e524b;" onclick="setTheme('sakura')">ğŸŒ¸ æ«»èŠ±ç²‰</div>
                <div class="theme-btn" style="background:#e6f0e6; color:#4b5e4b;" onclick="setTheme('matcha')">ğŸµ æŠ¹èŒ¶ç¶ </div>
                <div class="theme-btn" style="background:#e0f7fa; color:#3e505b;" onclick="setTheme('ocean')">ğŸŒŠ æ·±æµ·è—</div>
                <div class="theme-btn" style="background:#333; color:#fff;" onclick="setTheme('dark')">ğŸŒ™ å¤œé–“æ¨¡å¼</div>
            </div>
        </div>
        
        <!-- NEW: Full CSV Import/Export -->
        <div class="card">
            <h3>ğŸ“Š CSV åŒ¯å‡º / åŒ¯å…¥ (Excel ç·¨è¼¯)</h3>
            <div style="margin-bottom:10px; font-size:13px; color:var(--text-light);">
                å¯å°‡æ‰€æœ‰è³‡æ–™åŒ¯å‡ºç‚ºå–®ä¸€ CSV æª”ï¼Œç”¨ Excel ç·¨è¼¯å¾Œå†è²¼å›åŒ¯å…¥ã€‚
            </div>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button onclick="exportAllCSV()" class="btn-secondary" style="flex:1; background:#e3f2fd; color:#1565c0;">ğŸ“¤ åŒ¯å‡ºæ‰€æœ‰è³‡æ–™ (CSV)</button>
            </div>
            <button onclick="openImportCSVModal()" class="btn-add-block" style="border:1px dashed #999; color:#555;">ğŸ“¥ åŒ¯å…¥ CSV è³‡æ–™</button>
        </div>

        <!-- Backup & Restore -->
        <div class="card">
            <h3>ğŸ’¾ æ•´æ©Ÿå‚™ä»½èˆ‡é‚„åŸ</h3>
            <div style="margin-bottom:10px; font-size:13px; color:var(--text-light);">å°‡æ‰€æœ‰è³‡æ–™å°å­˜ç‚ºæª”æ¡ˆ (JSON)ã€‚</div>
            <div style="display:flex; gap:10px;">
                <button onclick="downloadBackup()" class="btn-secondary" style="flex:1;">ğŸ“¤ åŒ¯å‡ºå‚™ä»½ (Export)</button>
                <button onclick="document.getElementById('import-file').click()" class="btn-secondary" style="flex:1;">ğŸ“¥ åŒ¯å…¥è³‡æ–™ (Import)</button>
                <input type="file" id="import-file" style="display:none" accept=".json" onchange="restoreBackup(this)">
            </div>
        </div>
    </div>
</div>

<!-- MODALS -->
<div id="edit-modal" class="modal-overlay">
    <div class="modal">
        <h3 id="modal-title">ç·¨è¼¯</h3>
        <div id="modal-content"></div>
        <div class="modal-actions"></div>
    </div>
</div>

<div id="img-modal" class="modal-overlay" onclick="this.style.display='none'" style="z-index:300;">
    <div class="modal" style="background:transparent; box-shadow:none; text-align:center;">
        <img id="img-modal-src">
    </div>
</div>

<script>
    /* --- UTILS --- */
    let confirmCallback = null;
    function openModal(title, content, actions) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-content').innerHTML = content;
        document.querySelector('.modal-actions').innerHTML = actions;
        document.getElementById('edit-modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('edit-modal').style.display = 'none'; }
    function showAlert(msg) { openModal("æç¤º", `<div style="padding:10px;">${msg}</div>`, `<button onclick="closeModal()" class="btn-save">ç¢ºå®š</button>`); }
    function openConfirm(msg, callback) {
        confirmCallback = callback;
        openModal("ç¢ºèª", `<div style="padding:10px;">${msg}</div>`, `<button onclick="closeModal()" class="btn-cancel">å–æ¶ˆ</button><button onclick="if(confirmCallback) confirmCallback(); closeModal();" class="btn-save" style="background:var(--danger);">ç¢ºå®š</button>`);
    }

    /* --- DATA MANAGEMENT (MULTI-TRIP) --- */
    let tripIndex = JSON.parse(localStorage.getItem('travel_app_index')) || [];
    let currentTripId = localStorage.getItem('travel_app_current_id');
    let appData = {};

    const DEFAULT_DATA_TEMPLATE = {
        title: "ğŸŒ¸ ä¹å·è³æ«»æ‰‹å¸³",
        dates: "2026.03.26 - 03.30 | æ˜Ÿå®‡èˆªç©º",
        theme: 'sakura',
        rates: { JPY: 0.21, TWD: 1, KRW: 0.024, USD: 31.5, CNY: 4.4, EUR: 34.5, THB: 0.9 },
        activeCurrencies: ["JPY", "TWD", "USD"],
        transportTypes: ['é£›æ©Ÿ','JR/éµè·¯','æ–°å¹¹ç·š','å·´å£«','ç§Ÿè»Š','åœ°éµ','èˆ¹é‹'],
        booking: {
            flights: "å»ç¨‹ï¼šæ˜Ÿå®‡èˆªç©º JX840 (10:00 TPE -> 13:00 FUK)\nå›ç¨‹ï¼šæ˜Ÿå®‡èˆªç©º JX841 (14:00 FUK -> 15:30 TPE)",
            hotels: [
                { name: "Candeo Hotels Fukuoka Tenjin", desc: "Day 1-2 | ç¦å²¡å¸‚ä¸­å¤®å€", mapQuery: "Candeo Hotels Fukuoka Tenjin" }
            ]
        },
        itinerary: [
            {
                date: "DAY 1 (03/26)", weather: "ğŸŒ¤ï¸ ç¦å²¡ 12-18Â°C",
                events: [
                    { time: "13:45", title: "âœˆï¸ æŠµé”ç¦å²¡æ©Ÿå ´", desc: "å–è»Šã€è²·é›¶é£Ÿ", mapQuery: "", linkUrl: "", weatherQuery: "Fukuoka Airport" }
                ]
            }
        ],
        guides: [
            { title: "å­¸å•ä¹‹ç¥ï¼šå¤ªå®°åºœ", content: "ä¾›å¥‰å­¸å•ä¹‹ç¥è…åŸé“çœŸ...", mapQuery: "å¤ªå®°åºœå¤©æ»¿å®®" }
        ],
        checklist: [ { id: 1, text: "è­·ç…§", checked: false }, { id: 2, text: "æ—¥å¹£ç¾é‡‘", checked: false } ],
        memos: [ { id: 1, text: "è¨‚ä½ä»£è™Ÿ: XYZ123" } ],
        emergency: [ { id: 1, title: "è­¦å¯Ÿå±€", content: "110" }, { id: 2, title: "æ•‘è­·è»Š", content: "119" } ],
        notes: [ { id: 1, title: "æº«æ³‰", content: "åˆºé’è€…éœ€æ³¨æ„" } ],
        companions: ["æˆ‘"], expenses: [], transport: [], tickets: []
    };

    // CANADA TRIP DATA EXTRACTED FROM PDF
    const CANADA_DATA_TEMPLATE = {
        title: "ğŸ‡¨ğŸ‡¦ 2025 åŠ æ‹¿å¤§æ¥µå…‰ä¹‹æ—…",
        dates: "2025.01.23 - 02.01 | ä¸­è¯èˆªç©º+åŠ æ‹¿å¤§èˆªç©º",
        theme: 'ocean',
        rates: { CAD: 23.5, TWD: 1, USD: 32, JPY: 0.21 }, // Approx rates
        activeCurrencies: ["CAD", "TWD", "USD"],
        transportTypes: ['é£›æ©Ÿ','å·´å£«','æ¥é§è»Š','Uber','è¼•è»Œ'],
        booking: {
            flights: "1/23 TPE->YVR (CI022) 23:35-23:55\n1/24 YVR->YYC (AC7762) 06:30-08:55\n1/27 YYC->YZF (WS0221) 11:15-13:40\n1/29 YZF->YVR (AC8479) 17:10-18:58\n2/01 YVR->TPE (CI031) 00:35-05:40(+1)",
            hotels: [
                { name: "Banff Park Lodge (ç­å¤«é…’åº—)", desc: "1/24 - 1/26 (2æ™š) | ç­å¤«", mapQuery: "501 Banff Avenue, Banff" },
                { name: "Coast Calgary Downtown Hotel", desc: "1/26 - 1/27 (1æ™š) | å¡åŠ åˆ©", mapQuery: "610 4th Avenue Southwest, Calgary" },
                { name: "Quality Inn / Super 8", desc: "1/27 - 1/29 (2æ™š) | é»ƒåˆ€é®æ¥µå…‰åœ˜", mapQuery: "Yellowknife, NT" },
                { name: "æº«å“¥è¯ä½å®¿", desc: "1/29 - 1/31 (2æ™š) | æº«å“¥è¯", mapQuery: "Vancouver, BC" }
            ]
        },
        itinerary: [
            {
                date: "Day 0 (1/23)", weather: "âœˆï¸",
                events: [
                    { time: "23:35", title: "æ¡ƒåœ’æ©Ÿå ´èµ·é£›", desc: "CI022 -> æº«å“¥è¯", mapQuery: "Taoyuan Airport", weatherQuery: "" },
                    { time: "23:55", title: "æŠµé”æº«å“¥è¯", desc: "ç•¶åœ°æ™‚é–“ 1/23 æ™šä¸Š", mapQuery: "YVR Airport", weatherQuery: "Vancouver" }
                ]
            },
            {
                date: "Day 1 (1/24)", weather: "â„ï¸ ç­å¤«",
                events: [
                    { time: "06:30", title: "é£›å¾€å¡åŠ åˆ©", desc: "AC7762, 08:55 æŠµé”", mapQuery: "YVR Airport", weatherQuery: "" },
                    { time: "14:30", title: "å·´å£«å‰å¾€ç­å¤«", desc: "FlixBus / Universal Coach", mapQuery: "Calgary", weatherQuery: "" },
                    { time: "16:00", title: "æŠµé”ç­å¤«", desc: "å…¥ä½é£¯åº—", mapQuery: "Banff", weatherQuery: "Banff" }
                ]
            },
            {
                date: "Day 2 (1/25)", weather: "ğŸ”ï¸ ç­å¤«",
                events: [
                    { time: "08:15", title: "é‡ç”Ÿå‹•ç‰©å°å·´ä¹‹æ—…", desc: "å°‹æ‰¾éº‹é¹¿ã€å¤§è§’ç¾Šã€‚æ™¯é»: å¼“ç€‘å¸ƒã€é©šå–œè§’", mapQuery: "Banff Avenue", weatherQuery: "Banff" },
                    { time: "13:12", title: "ç´„ç¿°æ–¯é “å³½è°·å†°ä¸Šå¥è¡Œ", desc: "Johnston Canyon Icewalk (4hr)", mapQuery: "Johnston Canyon", weatherQuery: "" }
                ]
            },
            {
                date: "Day 3 (1/26)", weather: "ğŸšŒ å¡åŠ åˆ©",
                events: [
                    { time: "11:00", title: "é€€æˆ¿ / è‡ªç”±æ´»å‹•", desc: "", mapQuery: "", weatherQuery: "" },
                    { time: "14:30", title: "å·´å£«è¿”å›å¡åŠ åˆ©", desc: "", mapQuery: "", weatherQuery: "" },
                    { time: "16:00", title: "æŠµé”å¡åŠ åˆ©", desc: "å…¥ä½ Coast Calgary Hotel", mapQuery: "Coast Calgary Downtown Hotel", weatherQuery: "Calgary" }
                ]
            },
            {
                date: "Day 4 (1/27)", weather: "ğŸŒŒ é»ƒåˆ€é®",
                events: [
                    { time: "11:15", title: "é£›å¾€é»ƒåˆ€é®", desc: "WS0221, 13:40 æŠµé”", mapQuery: "Calgary Airport", weatherQuery: "" },
                    { time: "22:00", title: "æ¥µå…‰ç‹©çµ (Aurora Hunting)", desc: "è¿½æ¥µå…‰ 4å°æ™‚", mapQuery: "Yellowknife", weatherQuery: "Yellowknife" }
                ]
            },
            {
                date: "Day 5 (1/28)", weather: "ğŸ• é»ƒåˆ€é®",
                events: [
                    { time: "12:00", title: "ç‹—æ‹‰é›ªæ©‡ (Dog Sledding)", desc: "é«”é©—é›ªåœ°å¥”é¦³", mapQuery: "Yellowknife", weatherQuery: "" },
                    { time: "22:00", title: "æ¥µå…‰ç‹©çµ Day 2", desc: "å†æ¬¡è¿½æ¥µå…‰", mapQuery: "", weatherQuery: "" }
                ]
            },
            {
                date: "Day 6 (1/29)", weather: "ğŸ™ï¸ æº«å“¥è¯",
                events: [
                    { time: "17:10", title: "é£›å¾€æº«å“¥è¯", desc: "AC8479, 18:58 æŠµé”", mapQuery: "Yellowknife Airport", weatherQuery: "" },
                    { time: "20:00", title: "å…¥ä½æº«å“¥è¯é£¯åº—", desc: "", mapQuery: "Vancouver", weatherQuery: "Vancouver" }
                ]
            },
            {
                date: "Day 7 (1/30)", weather: "ğŸŒ² æº«å“¥è¯",
                events: [
                    { time: "10:00", title: "å²ä¸¹åˆ©å…¬åœ’ (Stanley Park)", desc: "åœ–é¨°æŸ±ã€ç…é–€å¤§æ©‹", mapQuery: "Stanley Park", weatherQuery: "Vancouver" },
                    { time: "14:00", title: "å›ºè˜­å³¶ (Granville Island)", desc: "å…¬çœ¾å¸‚å ´ã€å·¥è—å“", mapQuery: "Granville Island", weatherQuery: "" }
                ]
            },
            {
                date: "Day 8 (1/31)", weather: "ğŸŒ‰ æº«å“¥è¯",
                events: [
                    { time: "10:00", title: "å¡çš®æ‹‰è«¾åŠæ©‹å…¬åœ’", desc: "Capilano Suspension Bridge", mapQuery: "Capilano Suspension Bridge", weatherQuery: "" },
                    { time: "15:00", title: "ç…¤æ°£é® (Gastown)", desc: "è’¸æ±½é˜ Steam Clock", mapQuery: "Gastown Steam Clock", weatherQuery: "" },
                    { time: "22:00", title: "å‰å¾€æ©Ÿå ´", desc: "æº–å‚™æ­æ©Ÿ", mapQuery: "YVR Airport", weatherQuery: "" }
                ]
            },
            {
                date: "Day 9 (2/01)", weather: "âœˆï¸",
                events: [
                    { time: "00:35", title: "é£›å¾€å°åŒ—", desc: "CI031, é è¨ˆ 2/2 05:40 æŠµé”", mapQuery: "", weatherQuery: "" }
                ]
            }
        ],
        checklist: [
            { id: 1, text: "è­·ç…§ (æœ‰æ•ˆæœŸé™å…§)", checked: false },
            { id: 2, text: "åŠ æ‹¿å¤§ eTA ç°½è­‰", checked: false },
            { id: 3, text: "ç¾åœ‹ ESTA (è‹¥è½‰æ©Ÿéœ€è¦)", checked: false },
            { id: 4, text: "ç¦¦å¯’è¡£ç‰© (ç¾½çµ¨ã€ç™¼ç†±è¡£)", checked: false },
            { id: 5, text: "æ‰‹å¥—ã€æ¯›å¸½ã€åœå·¾", checked: false },
            { id: 6, text: "å¢¨é¡ (é›ªåœ°åå…‰)", checked: false },
            { id: 7, text: "ä¿æ¿•ä¹³æ¶²/è­·å”‡è†", checked: false }
        ],
        memos: [
            { id: 1, text: "ç·Šæ€¥é›»è©±: 911" },
            { id: 2, text: "é›»å£“: 110V (åŒå°ç£)" },
            { id: 3, text: "å°è²»: é¤å»³ç´„ 15-20%" }
        ],
        guides: [
            { title: "ä¼´æ‰‹ç¦®æ¨è–¦", content: "å†°é…’ (Ice Wine)ã€æ¥“ç³–æ¼¿ã€æ¥“ç³–é¤…ä¹¾ (Dare)ã€Roots æœé£¾ã€Lululemon", mapQuery: "" },
            { title: "å…¥å¢ƒé ˆçŸ¥", content: "å…ç¨…é¡ç´„ CAD $800ã€‚æ¶²é«”éš¨èº«æ”œå¸¶ä¸è¶…é 100mlã€‚", mapQuery: "" }
        ],
        emergency: [
            { id: 1, title: "å¤–äº¤éƒ¨ç·Šæ€¥è¯çµ¡", content: "é§æº«å“¥è¯è¾¦äº‹è™•: +1-604-377-8730" }
        ],
        notes: [
            { id: 1, title: "æ™‚å·®", content: "æº«å“¥è¯æ…¢å°ç£ 16 å°æ™‚ (ç­å¤«/é»ƒåˆ€é®æ…¢ 15 å°æ™‚)" }
        ],
        expenses: [
            { id: 1, item: "æ©Ÿç¥¨-TPE/YVRä¾†å›", amount: 34397, currency: "TWD", category: "transport", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 2, item: "æ©Ÿç¥¨-YVR/YYCå–®ç¨‹", amount: 3980, currency: "TWD", category: "transport", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 3, item: "å·´å£«-å¡åŠ åˆ©/ç­å¤«", amount: 642, currency: "TWD", category: "transport", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 4, item: "æ©Ÿç¥¨-YYC/YZFå–®ç¨‹", amount: 10503, currency: "TWD", category: "transport", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 5, item: "æ©Ÿç¥¨-YZF/YVRå–®ç¨‹", amount: 15322, currency: "TWD", category: "transport", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 6, item: "ç°½è­‰-åŠ æ‹¿å¤§eTA", amount: 165, currency: "TWD", category: "other", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 7, item: "ä½å®¿-ç­å¤«(2æ™š)", amount: 4562, currency: "TWD", category: "stay", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 8, item: "è¡Œç¨‹-ç­å¤«ä¸€æ—¥éŠ", amount: 4614, currency: "TWD", category: "ticket", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 9, item: "è¡Œç¨‹-é»ƒåˆ€é®æ¥µå…‰", amount: 15397, currency: "TWD", category: "ticket", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" },
            { id: 10, item: "è¡Œç¨‹-é›ªæ©‡çŠ¬", amount: 3838, currency: "TWD", category: "ticket", payer: "æˆ‘", splitWith: ["æˆ‘"], photo: "" }
        ],
        companions: ["æˆ‘"], transport: [], tickets: []
    };

    function initApp() {
        // Load Index
        tripIndex = JSON.parse(localStorage.getItem('travel_app_index')) || [];
        
        // 1. Ensure Default Kyushu Trip exists (if empty)
        if (tripIndex.length === 0) {
            const kyushuId = 'trip_kyushu_demo';
            localStorage.setItem('trip_data_' + kyushuId, JSON.stringify(DEFAULT_DATA_TEMPLATE));
            tripIndex.push({ id: kyushuId, title: DEFAULT_DATA_TEMPLATE.title });
        }

        // 2. Ensure Canada Trip exists (Auto-add feature)
        const hasCanada = tripIndex.some(t => t.title.includes("åŠ æ‹¿å¤§"));
        if (!hasCanada) {
            const canadaId = 'trip_canada_2025';
            localStorage.setItem('trip_data_' + canadaId, JSON.stringify(CANADA_DATA_TEMPLATE));
            tripIndex.push({ id: canadaId, title: CANADA_DATA_TEMPLATE.title });
            // Save index update
            localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
            // Show alert on first load
            setTimeout(() => showAlert("ğŸ‰ å·²è‡ªå‹•ç‚ºæ‚¨æ–°å¢ã€ŒğŸ‡¨ğŸ‡¦ 2025 åŠ æ‹¿å¤§æ¥µå…‰ä¹‹æ—…ã€æ‰‹å¸³ï¼<br>è«‹é»æ“Šå·¦ä¸Šè§’ ğŸ“š åˆ‡æ›æŸ¥çœ‹ã€‚"), 500);
        }

        // 3. Load current or first trip
        currentTripId = localStorage.getItem('travel_app_current_id');
        if (!currentTripId || !tripIndex.find(t => t.id === currentTripId)) {
            currentTripId = tripIndex[0].id;
        }
        loadTrip(currentTripId);
    }

    function loadTrip(id) {
        currentTripId = id;
        localStorage.setItem('travel_app_current_id', id);
        const json = localStorage.getItem('trip_data_' + id);
        appData = json ? JSON.parse(json) : JSON.parse(JSON.stringify(DEFAULT_DATA_TEMPLATE));
        if(!appData.transportTypes) appData.transportTypes = DEFAULT_DATA_TEMPLATE.transportTypes;
        if(!appData.activeCurrencies) appData.activeCurrencies = ["JPY", "TWD", "USD"];
        refreshAllUI();
    }

    function saveData() {
        try {
            localStorage.setItem('trip_data_' + currentTripId, JSON.stringify(appData));
            const idx = tripIndex.findIndex(t => t.id === currentTripId);
            if (idx !== -1) {
                tripIndex[idx].title = appData.title;
                localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
            }
        } catch (e) {
            if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                showAlert("âš ï¸ å„²å­˜ç©ºé–“å·²æ»¿ï¼<br>åœ–ç‰‡å¯èƒ½å¤ªå¤šäº†ï¼Œè«‹åˆªé™¤ä¸€äº›åœ–ç‰‡æˆ–èˆŠçš„æ—…ç¨‹ã€‚");
            } else {
                console.error(e);
                showAlert("âš ï¸ å„²å­˜å¤±æ•—ï¼Œç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ã€‚");
            }
        }
    }

    /* --- CSV EXPORT/IMPORT CORE --- */
    function arrayToCSV(arr) {
        if (!arr || !arr.length) return "";
        const keys = Object.keys(arr[0]);
        const header = keys.join(",");
        const rows = arr.map(obj => {
            return keys.map(k => {
                let val = obj[k] === null || obj[k] === undefined ? "" : String(obj[k]);
                val = val.replace(/"/g, '""'); // Escape double quotes
                if (val.includes(",") || val.includes("\n") || val.includes('"')) {
                    val = `"${val}"`;
                }
                return val;
            }).join(",");
        }).join("\n");
        return header + "\n" + rows;
    }

    function csvToArray(str, delimiter = ",") {
        const headers = str.slice(0, str.indexOf("\n")).split(delimiter).map(h => h.trim());
        const rows = str.slice(str.indexOf("\n") + 1).split("\n");
        const arr = [];
        rows.forEach(row => {
            if(!row.trim()) return;
            const values = [];
            let inQuote = false;
            let val = "";
            for(let i=0; i<row.length; i++) {
                const char = row[i];
                if(char === '"' && row[i+1] === '"') { val += '"'; i++; }
                else if(char === '"') { inQuote = !inQuote; }
                else if(char === delimiter && !inQuote) { values.push(val); val = ""; }
                else { val += char; }
            }
            values.push(val);
            const obj = {};
            headers.forEach((h, i) => obj[h] = values[i]);
            arr.push(obj);
        });
        return arr;
    }

    function exportAllCSV() {
        const data = [];
        
        // Flight
        if(appData.booking.flights) {
            data.push({ DataType: 'flight', Detail: appData.booking.flights });
        }
        
        // Hotels
        appData.booking.hotels.forEach(h => {
            data.push({ DataType: 'hotel', Subject: h.name, Detail: h.desc, Location: h.mapQuery });
        });

        // Itinerary
        appData.itinerary.forEach(day => {
            day.events.forEach(ev => {
                data.push({
                    DataType: 'itinerary',
                    Date: day.date,
                    Status: day.weather,
                    Time: ev.time,
                    Subject: ev.title,
                    Detail: ev.desc,
                    Location: ev.mapQuery,
                    Metadata: ev.weatherQuery
                });
            });
        });

        // Transport
        appData.transport.forEach(t => {
            data.push({
                DataType: 'transport',
                Date: t.date,
                Subject: t.type,
                From: t.from,
                To: t.to,
                Detail: t.note,
                Location: t.link
            });
        });

        // Tickets
        appData.tickets.forEach(t => {
            data.push({ DataType: 'ticket', Date: t.date, Subject: t.title, Detail: t.note });
        });

        // Expenses
        appData.expenses.forEach(e => {
            data.push({
                DataType: 'expense',
                Subject: e.item,
                Amount: e.amount,
                Currency: e.currency,
                Category: e.category,
                Payer: e.payer,
                Metadata: e.splitWith.join('|')
            });
        });

        // Guides
        appData.guides.forEach(g => {
            data.push({ DataType: 'guide', Subject: g.title, Detail: g.content, Location: g.mapQuery });
        });

        // Lists
        appData.checklist.forEach(i => data.push({ DataType: 'checklist', Subject: i.text, Status: i.checked }));
        appData.memos.forEach(i => data.push({ DataType: 'memo', Subject: i.text }));
        appData.emergency.forEach(i => data.push({ DataType: 'emergency', Subject: i.title, Detail: i.content }));
        appData.notes.forEach(i => data.push({ DataType: 'note', Subject: i.title, Detail: i.content }));

        if(data.length === 0) { showAlert("ç„¡è³‡æ–™å¯åŒ¯å‡º"); return; }

        // Standardize columns
        const allKeys = ['DataType', 'Date', 'Time', 'Subject', 'Detail', 'Location', 'From', 'To', 'Amount', 'Currency', 'Category', 'Payer', 'Status', 'Metadata'];
        const formattedData = data.map(item => {
            const row = {};
            allKeys.forEach(k => row[k] = item[k] || '');
            return row;
        });

        const csvContent = "\uFEFF" + arrayToCSV(formattedData);
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = appData.title + "_AllData.csv";
        link.click();
    }

    function openImportCSVModal() {
        const html = `
            <div class="form-group">
                <label class="form-label">è²¼ä¸Š CSV å…§å®¹ (åŒ…å«æ¨™é¡Œåˆ—)</label>
                <textarea id="import-csv-text" class="form-textarea" style="height:200px; font-family:monospace; font-size:12px;" placeholder="DataType,Date,Time,Subject...\n..."></textarea>
            </div>
            <div style="font-size:11px; color:var(--danger); margin-top:5px;">âš ï¸ åŒ¯å…¥å°‡æœƒã€Œè¦†è“‹ã€ç›®å‰çš„æ‰€æœ‰è³‡æ–™ï¼Œè«‹ç¢ºèª CSV æ ¼å¼æ­£ç¢ºã€‚</div>
        `;
        openModal("åŒ¯å…¥ CSV (å…¨è³‡æ–™)", html, `<button onclick="closeModal()" class="btn-cancel">å–æ¶ˆ</button><button onclick="processCSVImport()" class="btn-save">ç¢ºèªåŒ¯å…¥</button>`);
    }

    function processCSVImport() {
        const text = document.getElementById('import-csv-text').value;
        if(!text.trim()) return;

        try {
            const rawData = csvToArray(text);
            
            // Reset Data Arrays
            const newBooking = { flights: "", hotels: [] };
            const newItinerary = [];
            const newTransport = [];
            const newTickets = [];
            const newExpenses = [];
            const newGuides = [];
            const newChecklist = [];
            const newMemos = [];
            const newEmergency = [];
            const newNotes = [];

            // Helper for Itinerary
            let currentDay = null;

            rawData.forEach(row => {
                const type = (row.DataType || "").toLowerCase();
                const subj = row.Subject || "";
                
                if (type === 'flight' || type === 'flight_info') newBooking.flights = row.Detail || "";
                
                else if (type === 'hotel') newBooking.hotels.push({ name: subj, desc: row.Detail, mapQuery: row.Location });
                
                else if (type === 'itinerary') {
                    if (!row.Date) return;
                    if (!currentDay || currentDay.date !== row.Date) {
                        if(currentDay) newItinerary.push(currentDay);
                        currentDay = { date: row.Date, weather: row.Status || "â˜€ï¸", events: [] };
                    }
                    if (subj) {
                        currentDay.events.push({
                            time: row.Time || "", title: subj, desc: row.Detail || "", 
                            mapQuery: row.Location || "", weatherQuery: row.Metadata || ""
                        });
                    }
                }
                
                else if (type === 'transport') newTransport.push({ type: subj, date: row.Date, from: row.From, to: row.To, note: row.Detail, link: row.Location });
                
                else if (type === 'ticket') newTickets.push({ title: subj, date: row.Date, note: row.Detail });
                
                else if (type === 'expense') {
                    newExpenses.push({
                        id: Date.now() + Math.random(), item: subj, amount: parseFloat(row.Amount) || 0,
                        currency: row.Currency || "JPY", category: row.Category || "food",
                        payer: row.Payer || "æˆ‘", splitWith: row.Metadata ? row.Metadata.split('|') : ["æˆ‘"], photo: ""
                    });
                }
                
                else if (type === 'guide') newGuides.push({ title: subj, content: row.Detail, mapQuery: row.Location });
                
                else if (type === 'checklist') newChecklist.push({ text: subj, checked: (row.Status === 'true' || row.Status === true) });
                else if (type === 'memo') newMemos.push({ text: subj });
                else if (type === 'emergency') newEmergency.push({ title: subj, content: row.Detail });
                else if (type === 'note') newNotes.push({ title: subj, content: row.Detail });
            });

            if(currentDay) newItinerary.push(currentDay);

            // Apply new data
            appData.booking = newBooking;
            appData.itinerary = newItinerary;
            appData.transport = newTransport;
            appData.tickets = newTickets;
            appData.expenses = newExpenses;
            appData.guides = newGuides;
            appData.checklist = newChecklist;
            appData.memos = newMemos;
            appData.emergency = newEmergency;
            appData.notes = newNotes;

            saveData();
            refreshAllUI();
            showAlert("âœ… æ‰€æœ‰è³‡æ–™åŒ¯å…¥æˆåŠŸï¼");

        } catch(e) {
            console.error(e);
            showAlert("è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥ CSV æ ¼å¼ã€‚\n" + e.message);
        }
    }

    /* --- BACKUP & RESTORE (Existing) --- */
    function downloadBackup() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", appData.title + "_Backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function restoreBackup(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                if(!imported.title) throw new Error("ç„¡æ•ˆçš„æª”æ¡ˆæ ¼å¼");
                openConfirm("ç¢ºå®šè¦é‚„åŸæ­¤æª”æ¡ˆå—ï¼Ÿç›®å‰çš„è³‡æ–™å°‡è¢«è¦†è“‹ã€‚", () => {
                    appData = imported;
                    saveData();
                    refreshAllUI();
                    showAlert("âœ… é‚„åŸæˆåŠŸï¼");
                    input.value = ''; 
                });
            } catch(err) {
                showAlert("âŒ æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚");
            }
        };
        reader.readAsText(file);
    }
    
    /* --- COPY ITINERARY --- */
    function copyItineraryText() {
        let text = `ã€${appData.title}ã€‘\n${appData.dates}\n\n`;
        appData.itinerary.forEach(day => {
            text += `ğŸ“… ${day.date} (${day.weather})\n`;
            day.events.forEach(ev => {
                text += `  â€¢ ${ev.time} ${ev.title}\n`;
                if(ev.desc) text += `    è¨»: ${ev.desc}\n`;
            });
            text += `\n`;
        });
        
        navigator.clipboard.writeText(text).then(() => {
            showAlert("ğŸ“‹ è¡Œç¨‹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
        }).catch(err => {
            showAlert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½ã€‚");
        });
    }

    function createNewTrip(isSilent = false, customTitle = null) {
        const newId = 'trip_' + Date.now();
        const newData = JSON.parse(JSON.stringify(DEFAULT_DATA_TEMPLATE));
        if (customTitle) {
            newData.title = customTitle;
        } else if (!isSilent) {
            newData.title = "âœˆï¸ æ–°æ—…ç¨‹ " + (tripIndex.length + 1);
            newData.booking = { flights: "", hotels: [] };
            newData.itinerary = [];
            newData.expenses = [];
            newData.transport = [];
            newData.tickets = [];
        }
        
        try {
            localStorage.setItem('trip_data_' + newId, JSON.stringify(newData));
            tripIndex.push({ id: newId, title: newData.title });
            localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
            loadTrip(newId);
            if(!isSilent) openTripManager();
        } catch(e) {
            showAlert("ç„¡æ³•å»ºç«‹æ–°æ—…ç¨‹ï¼šå„²å­˜ç©ºé–“ä¸è¶³");
        }
    }

    function deleteSpecificTrip(id) {
        openConfirm("åˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ", () => {
            localStorage.removeItem('trip_data_' + id);
            tripIndex = tripIndex.filter(t => t.id !== id);
            localStorage.setItem('travel_app_index', JSON.stringify(tripIndex));
            if(id === currentTripId) {
                if(tripIndex.length > 0) loadTrip(tripIndex[0].id);
                else createNewTrip(true, "ğŸŒ¸ ä¹å·è³æ«»æ‰‹å¸³");
            }
            openTripManager();
        });
    }

    function switchTrip(id) { loadTrip(id); closeModal(); }

    function openTripManager() {
        let html = `<div style="max-height:300px; overflow-y:auto;">`;
        tripIndex.forEach(t => {
            const isActive = t.id === currentTripId ? 'active-trip' : '';
            html += `<div class="trip-item ${isActive}" onclick="switchTrip('${t.id}')"><div style="font-weight:bold;">${t.title}</div>${tripIndex.length > 1 ? `<button onclick="event.stopPropagation(); deleteSpecificTrip('${t.id}')" class="btn-delete-icon" style="font-size:14px;">ğŸ—‘ï¸</button>` : ''}</div>`;
        });
        html += `</div><button onclick="createNewTrip()" class="btn-add-block" style="margin-top:10px;">+ æ–°å¢æ—…ç¨‹</button>`;
        openModal("æˆ‘çš„æ‰‹å¸³åˆ—è¡¨", html, `<button onclick="closeModal()" class="btn-cancel">é—œé–‰</button>`);
    }

    function refreshAllUI() { 
        setTheme(appData.theme); 
        renderHeader(); 
        renderBooking(); 
        renderItinerary(); 
        renderGuide(); 
        renderExpenses(); 
        refreshLists(); 
        renderTransport(); 
        renderTickets(); 
        updateCalc(); 
        initWallet(); 
        fetchHomeWeather(); // New: Fetch Weather on refresh
    }

    /* --- THEME & HEADER --- */
    function setTheme(theme) { document.documentElement.setAttribute('data-theme', theme); appData.theme = theme; saveData(); }
    function renderHeader() { document.getElementById('app-title').innerText = appData.title; document.getElementById('app-dates').innerText = appData.dates; }
    function editHeader() { openModal("ç·¨è¼¯æ‰‹å¸³", `<div class="form-group"><label class="form-label">æ¨™é¡Œ</label><input id="et" value="${appData.title}" class="form-input"></div><div class="form-group"><label class="form-label">èªªæ˜</label><input id="ed" value="${appData.dates}" class="form-input"></div>`, `<button onclick="closeModal()" class="btn-cancel">å–æ¶ˆ</button><button onclick="appData.title=document.getElementById('et').value;appData.dates=document.getElementById('ed').value;renderHeader();saveData();closeModal()" class="btn-save">å„²å­˜</button>`); }

    /* --- NAVIGATION --- */
    function switchTab(tab) { 
        document.querySelectorAll('.content-view').forEach(el => el.classList.remove('active')); 
        document.getElementById(tab+'-view').classList.add('active'); 
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active')); 
        document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active'); 
        window.scrollTo(0,0);
    }
    function viewImage(src) { if(!src) return; document.getElementById('img-modal-src').src = src; document.getElementById('img-modal').style.display = 'flex'; }

    /* --- TRANSPORT --- */
    function renderTransport() {
        document.getElementById('transport-list').innerHTML = appData.transport.map((t, i) => `
            <div class="transport-card">
                <button onclick="openConfirm('åˆªé™¤æ­¤äº¤é€šï¼Ÿ', ()=>{appData.transport.splice(${i},1);saveData();renderTransport();})" class="btn-delete-icon" style="position:absolute; top:10px; right:10px;">âœ•</button>
                <div style="font-size:12px; color:var(--primary); font-weight:bold;">${t.type} Â· ${t.date}</div>
                <div style="font-size:16px; font-weight:bold; margin:5px 0;">${t.from} â ${t.to}</div>
                <div style="font-size:12px; color:#666; margin-bottom:5px;">${t.note || ''}</div>
                ${t.link ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(t.link)}" target="_blank" class="btn-action btn-map">ğŸ“ åœ°åœ–</a>` : ''}
                <button onclick="openTransportModal(${i})" class="btn-edit" style="float:right;">âœï¸</button>
            </div>`).join('') || `<div style="text-align:center; padding:20px; color:#aaa;">å°šç„¡äº¤é€šè³‡è¨Š</div>`;
    }
    function openTransportModal(idx=-1) {
        const isEdit = idx >= 0;
        const data = isEdit ? appData.transport[idx] : { type: appData.transportTypes[0], date: '', from: '', to: '', note: '', link: '' };
        const ops = appData.transportTypes.map(t => `<option ${data.type===t?'selected':''}>${t}</option>`).join('');
        const html = `<div class="form-group"><label class="form-label" style="display:flex;justify-content:space-between;">äº¤é€šé¡å‹<button onclick="openTransportTypeManager()" style="border:none;background:none;color:var(--primary);">âš™ï¸</button></label><select id="tr-type" class="form-select">${ops}</select></div><div class="form-group"><label class="form-label">æ—¥æœŸ/æ™‚é–“</label><input id="tr-date" value="${data.date}" class="form-input"></div><div style="display:flex;gap:10px;margin-bottom:12px;"><input id="tr-from" value="${data.from}" class="form-input" placeholder="å‡ºç™¼"><span style="align-self:center;">â</span><input id="tr-to" value="${data.to}" class="form-input" placeholder="æŠµé”"></div><div class="form-group"><label class="form-label">å‚™è¨»</label><input id="tr-note" value="${data.note}" class="form-input"></div><div class="form-group"><label class="form-label">åœ°åœ–é—œéµå­—</label><input id="tr-link" value="${data.link}" class="form-input"></div>`;
        openModal(isEdit?"ç·¨è¼¯äº¤é€š":"æ–°å¢äº¤é€š", html, `<button onclick="closeModal()" class="btn-cancel">å–æ¶ˆ</button><button onclick="saveTransport(${idx})" class="btn-save">å„²å­˜</button>`);
    }
    function openTransportTypeManager() {
        const html = `<div style="margin-bottom:15px;display:flex;gap:5px;"><input id="new-tr-type" class="form-input" placeholder="æ–°å¢é¡å‹"><button class="btn-save" onclick="if(document.getElementById('new-tr-type').value){appData.transportTypes.push(document.getElementById('new-tr-type').value);saveData();openTransportTypeManager();}">æ–°å¢</button></div><div style="display:flex;flex-wrap:wrap;gap:8px;">${appData.transportTypes.map(t => `<button onclick="openConfirm('åˆªé™¤ ${t}?', ()=>{appData.transportTypes=appData.transportTypes.filter(x=>x!=='${t}');saveData();openTransportTypeManager();})" style="padding:5px;background:#ffebee;border:none;border-radius:10px;">${t} âœ•</button>`).join('')}</div>`;
        openModal("ç®¡ç†é¡å‹", html, `<button onclick="closeModal()" class="btn-cancel">é—œé–‰</button>`);
    }
    function saveTransport(idx) {
        if(!document.getElementById('tr-type')) { closeModal(); return; }
        const newVal = { type: document.getElementById('tr-type').value, date: document.getElementById('tr-date').value, from: document.getElementById('tr-from').value, to: document.getElementById('tr-to').value, note: document.getElementById('tr-note').value, link: document.getElementById('tr-link').value };
        if(idx>=0) appData.transport[idx]=newVal; else appData.transport.push(newVal); saveData(); closeModal(); renderTransport();
    }

    // TICKETS
    function renderTickets() {
        document.getElementById('tickets-list').innerHTML = appData.tickets.map((t, i) => `
            <div class="ticket-card">
                <img src="${t.photo||''}" class="ticket-img" onclick="viewImage('${t.photo}')" style="${!t.photo?'display:flex;justify-content:center;align-items:center;background:#eee;color:#999;content:\'ç„¡åœ–\'':''}">
                <div class="ticket-info"><div style="font-weight:bold;">${t.title}</div><div style="font-size:12px;color:#666;">${t.date}</div><div style="font-size:13px;">${t.note}</div></div>
                <div class="ticket-actions"><button class="btn-edit" onclick="openTicketModal(${i})">âœï¸</button><button class="btn-delete-icon" onclick="openConfirm('åˆªé™¤ç¥¨åˆ¸ï¼Ÿ', ()=>{appData.tickets.splice(${i},1);saveData();renderTickets();})">ğŸ—‘ï¸</button></div>
            </div>`).join('') || `<div style="text-align:center; padding:20px; color:#aaa;">å°šç„¡ç¥¨åˆ¸</div>`;
    }
    function openTicketModal(idx=-1) {
        const isEdit = idx >= 0; const data = isEdit ? appData.tickets[idx] : { title: '', date: '', note: '', photo: '' };
        let html = `<div class="form-group"><label class="form-label">åç¨±</label><input id="tk-title" value="${data.title}" class="form-input"></div><div class="form-group"><label class="form-label">æ—¥æœŸ</label><input id="tk-date" value="${data.date}" class="form-input"></div><div class="form-group"><label class="form-label">å‚™è¨»</label><textarea id="tk-note" class="form-textarea">${data.note}</textarea></div><div class="form-group"><label class="form-label">åœ–ç‰‡</label><div onclick="document.getElementById('tk-file').click()" id="tk-preview" style="height:100px;background:#eee;display:flex;align-items:center;justify-content:center;">${data.photo?`<img src="${data.photo}" style="height:100%;">`:'é»æ“Šä¸Šå‚³'}</div><input type="file" id="tk-file" accept="image/*" style="display:none;" onchange="handleImg(this, 'tk-preview')"></div>`;
        openModal(isEdit?"ç·¨è¼¯ç¥¨åˆ¸":"æ–°å¢ç¥¨åˆ¸", html, `<button onclick="closeModal()" class="btn-cancel">å–æ¶ˆ</button><button onclick="saveTicket(${idx})" class="btn-save">å„²å­˜</button>`);
    }
    function handleImg(input, previewId) {
        if(input.files[0]) {
            const reader = new FileReader(); reader.onload=e=>{
                const img = new Image(); img.onload=()=>{
                    const c=document.createElement('canvas'); const max=800; const sc=max/img.width; c.width=max; c.height=img.height*sc; c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                    const b64=c.toDataURL('image/jpeg',0.7); document.getElementById(previewId).innerHTML=`<img src="${b64}" style="height:100%">`; document.getElementById(previewId).dataset.val=b64;
                }; img.src=e.target.result;
            }; reader.readAsDataURL(input.files[0]);
        }
    }
    function saveTicket(idx) {
        const ph = document.getElementById('tk-preview').dataset.val || (idx>=0?appData.tickets[idx].photo:'');
        const newVal = { title:document.getElementById('tk-title').value, date:document.getElementById('tk-date').value, note:document.getElementById('tk-note').value, photo:ph };
        if(idx>=0) appData.tickets[idx]=newVal; else appData.tickets.push(newVal); saveData(); closeModal(); renderTickets();
    }

    // LISTS
    function renderGenericList(cid, arr, type) {
        document.getElementById(cid).innerHTML = arr.map((item, i) => `
            <div class="list-item">
                ${type==='checklist'?`<label class="checkbox-wrapper" style="flex:1"><input type="checkbox" ${item.checked?'checked':''} onchange="appData.${type}[${i}].checked=!appData.${type}[${i}].checked;saveData();refreshLists();"><span style="${item.checked?'text-decoration:line-through;color:#ccc':''}">${item.text}</span></label>`:
                `<div style="flex:1"><div style="font-weight:bold;font-size:14px;">${item.title||''}</div><div style="white-space:pre-wrap;font-size:13px;">${item.text||item.content}</div></div>`}
                <button onclick="editList('${type}',${i})" class="btn-edit">âœï¸</button>
                <button onclick="openConfirm('åˆªé™¤ï¼Ÿ', ()=>{appData.${type}.splice(${i},1);saveData();refreshLists();})" class="btn-delete-icon">âœ•</button>
            </div>`).join('');
    }
    function addListItem(t) { openModal("æ–°å¢", t.includes('list')||t.includes('memos')?`<textarea id="li-txt" class="form-textarea"></textarea>`:`<input id="li-tit" class="form-input" placeholder="æ¨™é¡Œ"><textarea id="li-con" class="form-textarea" placeholder="å…§å®¹"></textarea>`, `<button onclick="saveList('${t}', -1)" class="btn-save">å„²å­˜</button>`); }
    function editList(t, i) { const d=appData[t][i]; openModal("ç·¨è¼¯", t.includes('list')||t.includes('memos')?`<textarea id="li-txt" class="form-textarea">${d.text}</textarea>`:`<input id="li-tit" value="${d.title}" class="form-input"><textarea id="li-con" class="form-textarea">${d.content}</textarea>`, `<button onclick="saveList('${t}', ${i})" class="btn-save">å„²å­˜</button>`); }
    function saveList(t, i) {
        const isS = t.includes('list')||t.includes('memos');
        const val = isS ? {text:document.getElementById('li-txt').value, checked:false} : {title:document.getElementById('li-tit').value, content:document.getElementById('li-con').value};
        if(i>=0 && isS) val.checked = appData[t][i].checked;
        if(i>=0) appData[t][i]=val; else appData[t].push(val); saveData(); closeModal(); refreshLists();
    }
    function refreshLists() { renderGenericList('checklist-container', appData.checklist, 'checklist'); renderGenericList('memos-container', appData.memos, 'memos'); renderGenericList('info-emergency-container', appData.emergency, 'emergency'); renderGenericList('info-notes-container', appData.notes, 'notes'); }

    // WALLET
    function initWallet() {
        const sel = document.getElementById('calc-currency'); sel.innerHTML = appData.activeCurrencies.map(c=>`<option>${c}</option>`).join('');
        updateCalc(); renderExpenses();
    }
    function updateCalc() {
        const c = document.getElementById('calc-currency').value || 'JPY'; const r = appData.rates[c] || 1; document.getElementById('calc-rate').value = r;
        try { 
            const inputVal = document.getElementById('calc-input').value;
            // Basic security check for eval
            if (/[^0-9+\-*/().\s]/.test(inputVal)) throw new Error("Invalid chars");
            const val = eval(inputVal); 
            document.getElementById('calc-result-raw').innerText = (val||0).toFixed(2); 
            document.getElementById('calc-result-twd').innerText = Math.round((val||0)*r).toLocaleString(); 
        } catch(e){
            // Silent catch
        }
    }
    function manualRateUpdate() { appData.rates[document.getElementById('calc-currency').value] = parseFloat(document.getElementById('calc-rate').value); saveData(); updateCalc(); renderExpenses(); }
    function openCurrencyManager() { openModal("ç®¡ç†å¹£åˆ¥", `<div style="display:flex;gap:5px;margin-bottom:10px;"><input id="new-c" class="form-input" placeholder="CODE"><input id="new-r" class="form-input" type="number" placeholder="Rate"><button class="btn-save" onclick="if(document.getElementById('new-c').value){appData.activeCurrencies.push(document.getElementById('new-c').value);appData.rates[document.getElementById('new-c').value]=document.getElementById('new-r').value;saveData();initWallet();closeModal();}">+</button></div><div>${appData.activeCurrencies.map(c=>`<button onclick="if('${c}'!=='TWD'){appData.activeCurrencies=appData.activeCurrencies.filter(x=>x!=='${c}');saveData();initWallet();closeModal();}" style="margin:2px;padding:5px;">${c} âœ•</button>`).join('')}</div>`, `<button onclick="closeModal()" class="btn-cancel">é—œé–‰</button>`); }
    function addExpenseFromCalc() { 
        try{ 
            const val = eval(document.getElementById('calc-input').value);
            if(isNaN(val)) throw new Error("NaN");
            openAddExpenseModal(-1, {amount: val, currency: document.getElementById('calc-currency').value}); 
        } catch(e){
            showAlert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—æˆ–ç®—å¼");
        } 
    }
    
    // EXPENSE CATEGORIES
    const EXP_CATS = [
        {val: 'food', icon: 'ğŸ”', name: 'é¤é£²'},
        {val: 'transport', icon: 'ğŸš—', name: 'äº¤é€š'},
        {val: 'shop', icon: 'ğŸ›ï¸', name: 'è³¼ç‰©'},
        {val: 'stay', icon: 'ğŸ¨', name: 'ä½å®¿'},
        {val: 'ticket', icon: 'ğŸ«', name: 'é–€ç¥¨'},
        {val: 'other', icon: 'ğŸ’¸', name: 'å…¶ä»–'}
    ];

    function openAddExpenseModal(idx, pre={}) {
        const d = idx>=0 ? appData.expenses[idx] : {item:'', amount:pre.amount||'', currency:pre.currency||'JPY', payer:'æˆ‘', splitWith:appData.companions, photo:'', category:'food'};
        
        // Category Options
        const catOpts = EXP_CATS.map(c => `<option value="${c.val}" ${d.category===c.val?'selected':''}>${c.icon} ${c.name}</option>`).join('');

        const html = `
        <div style="display:flex; gap:10px;">
            <div class="form-group" style="flex:1;">
                <label class="form-label">é¡åˆ¥</label>
                <select id="ex-cat" class="form-select">${catOpts}</select>
            </div>
            <div class="form-group" style="flex:2;">
                <label class="form-label">é …ç›®</label>
                <input id="ex-item" value="${d.item}" class="form-input">
            </div>
        </div>
        <div class="form-group"><label class="form-label">é‡‘é¡</label><div style="display:flex;gap:10px;"><input id="ex-amt" value="${d.amount}" class="form-input"><select id="ex-cur" class="form-select" style="width:80px;">${appData.activeCurrencies.map(c=>`<option ${c===d.currency?'selected':''}>${c}</option>`).join('')}</select></div></div><div class="form-group"><label class="form-label">èª°ä»˜</label><select id="ex-pay" class="form-select">${appData.companions.map(c=>`<option ${c===d.payer?'selected':''}>${c}</option>`).join('')}</select></div><div class="form-group"><label class="form-label">åˆ†å¸³</label><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;">${appData.companions.map(c=>`<label class="checkbox-wrapper"><input type="checkbox" class="sp-chk" value="${c}" ${d.splitWith.includes(c)?'checked':''}>${c}</label>`).join('')}</div></div><div class="form-group"><label class="form-label">åœ–ç‰‡</label><div onclick="document.getElementById('ex-file').click()" id="ex-prev" style="height:60px;background:#eee;display:flex;align-items:center;justify-content:center;">${d.photo?'åœ–':'ğŸ“·'}</div><input type="file" id="ex-file" style="display:none;" onchange="handleImg(this,'ex-prev')"></div>`;
        openModal(idx>=0?"ä¿®æ”¹":"æ–°å¢", html, `<button onclick="closeModal()" class="btn-cancel">å–æ¶ˆ</button><button onclick="saveEx(${idx})" class="btn-save">å„²å­˜</button>`);
        if(d.photo) document.getElementById('ex-prev').dataset.val = d.photo;
    }
    
    function saveEx(idx) {
        const p = document.getElementById('ex-prev').dataset.val || (idx>=0?appData.expenses[idx].photo:'');
        const sp = Array.from(document.querySelectorAll('.sp-chk:checked')).map(c=>c.value);
        const cat = document.getElementById('ex-cat').value;
        const n = { id:Date.now(), item:document.getElementById('ex-item').value, amount:parseFloat(document.getElementById('ex-amt').value), currency:document.getElementById('ex-cur').value, payer:document.getElementById('ex-pay').value, splitWith:sp, photo:p, category: cat };
        if(idx>=0) appData.expenses[idx]=n; else appData.expenses.unshift(n); saveData(); renderExpenses(); closeModal();
    }
    
    function renderExpenses() {
        let total = 0; let myShare = 0;
        document.getElementById('expense-list').innerHTML = appData.expenses.map((e,i) => {
            const r = appData.rates[e.currency]||1; total += e.amount*r;
            if(e.splitWith.includes('æˆ‘')) myShare += (e.amount/e.splitWith.length)*r;
            
            // Resolve icon
            const catObj = EXP_CATS.find(c=>c.val === e.category) || EXP_CATS[5];
            const icon = catObj.icon;

            return `<div class="expense-item">
                <div class="expense-thumb" onclick="event.stopPropagation();viewImage('${e.photo}')" style="${!e.photo?'background:#f0f0f0;color:#ccc':''}">
                    ${e.photo ? `<img src="${e.photo}" style="height:100%;width:100%;object-fit:cover;border-radius:8px;">` : icon}
                </div>
                <div style="flex:1" onclick="openAddExpenseModal(${i})">
                    <div style="font-weight:bold;">${e.item}</div>
                    <div style="font-size:12px;color:#666;">${e.amount} ${e.currency} (${e.payer})</div>
                </div>
                <div style="text-align:right" onclick="openAddExpenseModal(${i})">
                    <div>â‰ˆNT$ ${Math.round(e.amount*r)}</div>
                </div>
                <button onclick="event.stopPropagation();openConfirm('åˆªé™¤ï¼Ÿ', ()=>{appData.expenses.splice(${i},1);saveData();renderExpenses();})" class="btn-delete-icon">ğŸ—‘ï¸</button>
            </div>`;
        }).join('');
        document.getElementById('total-grand-twd').innerText = Math.round(total);
        document.getElementById('my-share-display').innerText = 'æˆ‘æ‡‰ä»˜: NT$ ' + Math.round(myShare);
    }
    
    function openCompanionsModal() { openModal("æ—…ä¼´", `<div id="comp-list">${appData.companions.map(c=>`<div style="display:flex;margin-bottom:5px;"><input class="form-input c-name" value="${c}"><button onclick="this.parentElement.remove()">âœ•</button></div>`).join('')}</div><button onclick="document.getElementById('comp-list').insertAdjacentHTML('beforeend', '<div><input class=\\'form-input c-name\\'></div>')">æ–°å¢</button>`, `<button onclick="appData.companions=Array.from(document.querySelectorAll('.c-name')).map(i=>i.value).filter(v=>v);saveData();closeModal();" class="btn-save">å„²å­˜</button>`); }
    function clearExpenses() { openConfirm("æ¸…é™¤æ‰€æœ‰ï¼Ÿ", ()=>{appData.expenses=[];saveData();renderExpenses();}); }

    // BOOKING & ITINERARY (UPDATED)
    function renderBooking() { 
        document.getElementById('booking-flights').innerText = appData.booking.flights; 
        
        // Updated Hotel Rendering with Edit/Delete
        document.getElementById('booking-hotels-container').innerHTML = appData.booking.hotels.map((h,i)=>`
            <div class="list-item">
                <div style="flex:1;">
                    <b>${h.name}</b>
                    <div style="font-size:13px;">${h.desc}</div>
                </div>
                <div style="display:flex; gap:5px; align-items:center;">
                    ${h.mapQuery ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h.mapQuery)}" target="_blank" class="btn-action btn-map">ğŸ“</a>` : ''}
                    <button onclick="openHotelModal(${i})" class="btn-edit">âœï¸</button>
                    <button onclick="openConfirm('åˆªé™¤?', ()=>{appData.booking.hotels.splice(${i},1);saveData();renderBooking();})" class="btn-delete-icon">âœ•</button>
                </div>
            </div>`).join(''); 
    }
    function editBookingText(t) { openModal("ç·¨è¼¯", `<textarea id="bt" class="form-textarea" style="height:150px;">${appData.booking[t]}</textarea>`, `<button onclick="appData.booking['${t}']=document.getElementById('bt').value;saveData();renderBooking();closeModal()" class="btn-save">å„²å­˜</button>`); }
    
    // NEW: Hotel Modal
    function openHotelModal(idx=-1) {
        const isEdit = idx >= 0;
        const d = isEdit ? appData.booking.hotels[idx] : { name:'', desc:'', mapQuery:'' };
        
        const html = `
            <div class="form-group"><label class="form-label">ä½å®¿åç¨±</label><input id="hn" value="${d.name}" class="form-input" placeholder="åç¨±"></div>
            <div class="form-group"><label class="form-label">æè¿° / æ™‚é–“</label><input id="hd" value="${d.desc}" class="form-input" placeholder="ä¾‹å¦‚: Day 1-2"></div>
            <div class="form-group"><label class="form-label">åœ°åœ–é—œéµå­—</label><input id="hm" value="${d.mapQuery}" class="form-input" placeholder="ç”¨æ–¼ Google Maps æœå°‹"></div>
        `;
        
        openModal(isEdit ? "ç·¨è¼¯ä½å®¿" : "æ–°å¢ä½å®¿", html, 
            `<button onclick="closeModal()" class="btn-cancel">å–æ¶ˆ</button>
             <button onclick="saveHotel(${idx})" class="btn-save">å„²å­˜</button>`);
    }

    function saveHotel(idx) {
        const newVal = {
            name: document.getElementById('hn').value,
            desc: document.getElementById('hd').value,
            mapQuery: document.getElementById('hm').value
        };
        
        if (idx >= 0) {
            appData.booking.hotels[idx] = newVal;
        } else {
            appData.booking.hotels.push(newVal);
        }
        
        saveData();
        renderBooking();
        closeModal();
    }
    
    // SMART WEATHER: Common POI to City mapping
    const POI_MAPPING = {
        "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´": "Taoyuan", "æ¡ƒåœ’æ©Ÿå ´": "Taoyuan", "TPE": "Taoyuan", "RCTP": "Taoyuan",
        "æ¾å±±æ©Ÿå ´": "Taipei", "TSA": "Taipei", "RCSS": "Taipei",
        "å°æ¸¯æ©Ÿå ´": "Kaohsiung", "KHH": "Kaohsiung", "RCKH": "Kaohsiung",
        "æˆç”°åœ‹éš›æ©Ÿå ´": "Narita", "æˆç”°æ©Ÿå ´": "Narita", "NRT": "Narita", "RJAA": "Narita",
        "ç¾½ç”°æ©Ÿå ´": "Tokyo", "HND": "Tokyo", "RJTT": "Tokyo",
        "é—œè¥¿åœ‹éš›æ©Ÿå ´": "Osaka", "é—œè¥¿æ©Ÿå ´": "Osaka", "KIX": "Osaka", "RJBB": "Osaka",
        "ç¦å²¡æ©Ÿå ´": "Fukuoka", "FUK": "Fukuoka", "RJFF": "Fukuoka",
        "ä¸­éƒ¨åœ‹éš›æ©Ÿå ´": "Tokoname", "NGO": "Tokoname", "RJGG": "Tokoname",
        "æ–°åƒæ­²æ©Ÿå ´": "Chitose", "CTS": "Chitose", "RJCC": "Chitose",
        "é‚£éœ¸æ©Ÿå ´": "Naha", "OKA": "Naha", "ROAH": "Naha",
        "å¤ªå®°åºœå¤©æ»¿å®®": "Dazaifu", "æ¸…æ°´å¯º": "Kyoto", "æ·ºè‰å¯º": "Tokyo", "æ±äº¬è¿ªå£«å°¼": "Urayasu", "ç’°çƒå½±åŸ": "Osaka"
    };

    // Shared Geo logic
    async function getGeoLocation(query) {
        let searchTerm = query;
        if (POI_MAPPING[query]) searchTerm = POI_MAPPING[query];
        
        const fetchGeo = async (q) => {
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(q)}&count=1&format=json`);
            return await res.json();
        };

        let geo = await fetchGeo(searchTerm);

        if (!geo.results) {
            const suffixes = ["åœ‹éš›æ©Ÿå ´", "æ©Ÿå ´", "ç©ºæ¸¯", "è»Šç«™", "ç«è»Šç«™", "é§…", "å¤©æ»¿å®®", "ç¥å®®", "å¤§ç¤¾", "å…¬åœ’", "å‹•ç‰©åœ’", "éŠæ¨‚åœ’", "è§€å…‰å¤œå¸‚", "å¤œå¸‚", "å¤§å­¸", "é«˜ä¸­", "åœ‹ä¸­", "åœ‹å°"];
            let cleanQuery = searchTerm;
            for (const suffix of suffixes) {
                if (cleanQuery.endsWith(suffix)) {
                    cleanQuery = cleanQuery.slice(0, -suffix.length);
                    break;
                }
            }
            if (cleanQuery !== searchTerm && cleanQuery.length > 1) {
                const retryGeo = await fetchGeo(cleanQuery);
                if (retryGeo.results) geo = retryGeo;
            }
        }
        return geo;
    }

    async function fetchRealWeather() {
        const input = document.getElementById('edit-weather'); const btn = document.getElementById('btn-get-weather');
        let query = "";
        
        const modalContent = document.getElementById('modal-content');
        const rows = modalContent.querySelectorAll('.event-edit-row');
        for (let row of rows) {
            const w = row.querySelector('.ewq').value.trim();
            if (w) { query = w; break; }
        }
        if (!query && rows.length > 0) {
            const firstRow = rows[0];
            const m = firstRow.querySelector('.em').value;
            const t = firstRow.querySelector('.eti').value;
            query = (m || t).replace(/[0-9]{2}:[0-9]{2}/g,'').trim();
        }

        if(!query) { showAlert("ç„¡åœ°é»å¯æŸ¥"); return; }
        
        btn.innerText = "â³"; 
        const originalValue = input.value; 
        
        try {
            const geo = await getGeoLocation(query);
            if(!geo.results || geo.results.length === 0) throw new Error("ç„¡çµæœ");
            
            const {latitude, longitude, name} = geo.results[0];
            const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto`)).json();
            
            if (!w.current_weather) throw new Error("Weather data missing");

            let icon = getWeatherIcon(w.current_weather.weathercode);
            input.value = `${icon} ${name} ${w.current_weather.temperature}Â°C`;
        } catch(e) { 
            console.error(e);
            input.value = originalValue; 
            showAlert(`æ‰¾ä¸åˆ° "${query}"ã€‚\næç¤º: è«‹è¼¸å…¥ã€ŒåŸå¸‚åç¨±ã€å¦‚: æ¡ƒåœ’ã€å°åŒ—`); 
        } finally { btn.innerText = "ğŸŒ"; }
    }

    // NEW: Fetch Home Weekly Weather (Updated with Clothing Advice)
    async function fetchHomeWeather() {
        const container = document.getElementById('weekly-weather-container');
        const nameDisplay = document.getElementById('weather-loc-name');
        
        // Find first location
        let query = null;
        if(appData.itinerary.length > 0 && appData.itinerary[0].events.length > 0) {
            const ev = appData.itinerary[0].events[0];
            query = ev.weatherQuery || ev.mapQuery || ev.title;
        }

        if(!query) {
            container.innerHTML = `<div style="width:100%; text-align:center; padding:10px; color:#aaa;">è«‹å…ˆè¨­å®šè¡Œç¨‹ç¬¬ä¸€å¤©åœ°é»ä»¥é¡¯ç¤ºå¤©æ°£</div>`;
            nameDisplay.innerText = "å°šç„¡åœ°é»";
            return;
        }

        nameDisplay.innerText = `æœå°‹: ${query}...`;
        
        try {
            const geo = await getGeoLocation(query);
            if(!geo.results || geo.results.length === 0) throw new Error("ç„¡çµæœ");
            
            const {latitude, longitude, name, country} = geo.results[0];
            nameDisplay.innerText = `${name}, ${country || ''}`;

            // FIX: Added apparent_temperature parameters
            const w = await (await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min&timezone=auto`)).json();
            
            if (!w.daily) {
                console.error("Weather API Error:", w);
                throw new Error("ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™");
            }

            let html = "";
            w.daily.time.forEach((t, i) => {
                const date = new Date(t);
                const dayName = date.toLocaleDateString('zh-TW', {weekday: 'short'});
                const shortDate = date.toLocaleDateString('zh-TW', {month: 'numeric', day: 'numeric'});
                const icon = getWeatherIcon(w.daily.weathercode[i]);
                const max = Math.round(w.daily.temperature_2m_max[i]);
                const min = Math.round(w.daily.temperature_2m_min[i]);
                const feelMax = Math.round(w.daily.apparent_temperature_max[i]);
                const feelMin = Math.round(w.daily.apparent_temperature_min[i]);
                
                const advice = getClothingAdvice(feelMax);

                html += `
                    <div class="weather-day-item">
                        <div style="font-size:12px; font-weight:bold;">${dayName}</div>
                        <div style="font-size:10px; opacity:0.7;">${shortDate}</div>
                        <div class="weather-icon-lg">${icon}</div>
                        <div style="font-size:13px; margin-bottom:2px;"><b>${max}Â°</b> <span style="font-size:11px;opacity:0.6">${min}Â°</span></div>
                        <div style="font-size:10px; color:#888;">é«”æ„Ÿ ${feelMax}Â°</div>
                        <div class="clothing-advice">${advice}</div>
                    </div>
                `;
            });
            container.innerHTML = html;

        } catch(e) {
            console.error(e);
            container.innerHTML = `<div style="text-align:center; padding:10px; color:#ff6b6b;">ç„¡æ³•å–å¾— "${query}" çš„å¤©æ°£</div>`;
            nameDisplay.innerText = "éŒ¯èª¤";
        }
    }

    function getClothingAdvice(temp) {
        if (temp >= 30) return "çŸ­è¢–/é˜²æ›¬";
        if (temp >= 25) return "é€æ°£è¡£ç‰©";
        if (temp >= 20) return "è–„å¤–å¥—";
        if (temp >= 15) return "å¤¾å…‹/é¢¨è¡£";
        if (temp >= 10) return "æ¯›è¡£/å¤§è¡£";
        if (temp >= 5) return "ç¾½çµ¨/åœå·¾";
        return "é‡ä¿æš–";
    }

    function getWeatherIcon(code) {
        if (code === 0) return "â˜€ï¸";
        if (code > 0 && code <= 3) return "â›…";
        if (code >= 45 && code <= 48) return "ğŸŒ«ï¸";
        if (code >= 51 && code <= 67) return "ğŸŒ§ï¸";
        if (code >= 71 && code <= 86) return "â„ï¸";
        if (code >= 95) return "âš¡";
        return "â“";
    }

    function renderItinerary() { document.getElementById('itinerary-container').innerHTML=appData.itinerary.map((d,i)=>`<div class="day-card"><div class="day-header"><span>${d.date} ${d.weather}</span><button onclick="editDay(${i})" class="btn-edit" style="color:white;">âœï¸</button></div><div class="timeline">${d.events.map(e=>`<div class="list-item" style="border:none;"><div style="width:40px;font-size:12px;">${e.time}</div><div style="flex:1"><b>${e.title}</b><div style="font-size:12px;color:#666;">${e.desc}</div>${e.mapQuery?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(e.mapQuery)}" target="_blank" class="btn-action btn-map">ğŸ“</a>`:''}</div></div>`).join('')}</div></div>`).join(''); }
    function addDay() { appData.itinerary.push({date:`Day ${appData.itinerary.length+1}`, weather:'â˜€ï¸', events:[]}); saveData(); renderItinerary(); }
    function editDay(i) { const d=appData.itinerary[i]; let html=`<div style="display:flex;gap:5px;margin-bottom:10px;"><input id="ed-date" value="${d.date}" class="form-input"><input id="edit-weather" value="${d.weather}" class="form-input"><button id="btn-get-weather" onclick="fetchRealWeather()">ğŸŒ</button></div><div id="ev-list">${d.events.map(e=>`<div class="event-edit-row"><div style="display:flex;gap:5px;margin-bottom:5px;"><input class="form-input et" value="${e.time}" style="width:50px"><input class="form-input eti" value="${e.title}" style="flex:1"></div><input class="form-input ed" value="${e.desc}"><div style="display:flex;gap:5px;margin-top:5px;"><input class="form-input em" value="${e.mapQuery||''}" placeholder="åœ°åœ–"><input class="form-input ewq" value="${e.weatherQuery||''}" placeholder="å¤©æ°£åœ°é»"></div><button onclick="this.parentElement.remove()" class="btn-remove-event">âœ•</button></div>`).join('')}</div><button onclick="document.getElementById('ev-list').insertAdjacentHTML('beforeend', '<div class=\\'event-edit-row\\'><div style=\\'display:flex;gap:5px;margin-bottom:5px;\\'><input class=\\'form-input et\\' placeholder=\\'æ™‚é–“\\'><input class=\\'form-input eti\\' placeholder=\\'æ¨™é¡Œ\\'></div><input class=\\'form-input ed\\' placeholder=\\'å‚™è¨»\\'><div style=\\'display:flex;gap:5px;margin-top:5px;\\'><input class=\\'form-input em\\' placeholder=\\'åœ°åœ–\\'><input class=\\'form-input ewq\\' placeholder=\\'å¤©æ°£åœ°é»\\'></div><button onclick=\\'this.parentElement.remove()\\' class=\\'btn-remove-event\\'>âœ•</button></div>')" class="btn-add-block">+ è¡Œç¨‹</button><button onclick="openConfirm('åˆªé™¤æ•´å¤©?', ()=>{appData.itinerary.splice(${i},1);saveData();renderItinerary();closeModal();})" class="btn-danger" style="width:100%;margin-top:10px;">åˆªé™¤æ•´å¤©</button>`; openModal("ç·¨è¼¯è¡Œç¨‹", html, `<button onclick="saveDay(${i})" class="btn-save">å„²å­˜</button>`); }
    function saveDay(i) {
        const modalContent = document.getElementById('modal-content');
        const evs = Array.from(modalContent.querySelectorAll('.event-edit-row')).map(r=>({time:r.querySelector('.et').value, title:r.querySelector('.eti').value, desc:r.querySelector('.ed').value, mapQuery:r.querySelector('.em').value, weatherQuery:r.querySelector('.ewq').value})).sort((a,b)=>a.time.localeCompare(b.time));
        appData.itinerary[i].date=document.getElementById('ed-date').value; appData.itinerary[i].weather=document.getElementById('edit-weather').value; appData.itinerary[i].events=evs; saveData(); renderItinerary(); closeModal();
        // Refresh home weather if first day changed
        if(i===0) fetchHomeWeather();
    }
    // GUIDE
    function renderGuide() { document.getElementById('guide-container').innerHTML = appData.guides.map((g,i)=>`<div class="card"><h3>${g.title} <button onclick="openConfirm('åˆªé™¤?', ()=>{appData.guides.splice(${i},1);saveData();renderGuide();})" class="btn-edit">âœ•</button></h3><p>${g.content}</p>${g.mapQuery?`<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(g.mapQuery)}" target="_blank" class="btn-action btn-map">ğŸ“</a>`:''}</div>`).join(''); }
    function addNewGuide() { openModal("æ–°å¢", `<input id="gt" class="form-input" placeholder="æ¨™é¡Œ"><textarea id="gc" class="form-textarea" placeholder="å…§å®¹"></textarea><input id="gm" class="form-input" placeholder="åœ°åœ–é—œéµå­—">`, `<button onclick="appData.guides.push({title:document.getElementById('gt').value, content:document.getElementById('gc').value, mapQuery:document.getElementById('gm').value});saveData();renderGuide();closeModal()" class="btn-save">å„²å­˜</button>`); }

    // Init
    initApp();
</script>
</body>
</html>
